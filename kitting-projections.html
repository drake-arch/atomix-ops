<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kitting Projections - Atomix OPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .gradient-bg {
      background: linear-gradient(-45deg, #0D2D53, #1a4d7a, #0D2D53, #164a6e);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    .grid-bg {
      background-image:
        linear-gradient(rgba(163, 243, 197, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(163, 243, 197, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }
    .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glow { box-shadow: 0 0 30px rgba(163, 243, 197, 0.3); }
  </style>
</head>

<body class="bg-[#101314] text-[#EDEFED]">
  <div class="min-h-screen gradient-bg grid-bg">
    <div class="relative z-10 px-6 py-12">
      <!-- Header -->
      <div class="max-w-7xl mx-auto mb-12">
        <button onclick="window.location.href='./index.html'" class="text-[#A3F3C5] hover:text-white transition-colors mb-6 flex items-center gap-2">
          <span>‚Üê</span> Back to Home
        </button>
        
        <div class="fade-in-up">
          <div class="inline-block px-6 py-2 glass rounded-full text-[#A3F3C5] text-sm font-medium tracking-widest uppercase mb-4 glow">
            Labor Planning
          </div>
          <h1 class="text-6xl font-extralight mb-4 bg-gradient-to-r from-white to-[#A3F3C5] bg-clip-text text-transparent">
            Kitting Analysis
          </h1>
          <p class="text-xl text-[#9D9F9E] font-light">Project staffing and track actual performance</p>
        </div>

        <!-- Mode Toggle -->
        <div class="mt-8 flex justify-center">
          <div class="glass rounded-full p-2 inline-flex gap-2">
            <button id="projectionBtn" onclick="switchMode('projection')" class="px-8 py-3 rounded-full font-medium transition-all bg-[#A3F3C5] text-[#0D2D53]">
              Projections
            </button>
            <button id="completionBtn" onclick="switchMode('completion')" class="px-8 py-3 rounded-full font-medium transition-all text-[#9D9F9E] hover:text-white">
              Completion
            </button>
            <button id="historyBtn" onclick="switchMode('history')" class="px-8 py-3 rounded-full font-medium transition-all text-[#9D9F9E] hover:text-white">
              History
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          <!-- Input Form - Projections Mode -->
          <div id="projectionsForm" class="glass rounded-3xl p-8 fade-in-up">
            <h2 class="text-3xl font-light mb-8 text-[#A3F3C5]">Project Details</h2>
            
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Project Name</label>
                <input type="text" id="projectName" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="Enter project name">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Kit Name/Type</label>
                <input type="text" id="kitName" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="Enter kit type">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Total Kits to Create</label>
                <input type="number" id="totalKits" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="1">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Expected Kits Per Hour (per person)</label>
                <input type="number" id="kitsPerHour" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="1" step="0.1">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Number of Days Available</label>
                <input type="number" id="numDays" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="1">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Hours Per Day</label>
                <input type="number" id="hoursPerDay" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="8" min="1" max="24" value="8">
              </div>

              <button onclick="calculateProjections()" 
                class="w-full bg-[#A3F3C5] hover:bg-[#8cd9ad] text-[#0D2D53] font-medium py-4 rounded-xl transition-all transform hover:scale-[1.02] glow">
                Calculate Projections
              </button>
            </div>
          </div>

          <!-- Input Form - Completion Mode -->
          <div id="completionForm" class="glass rounded-3xl p-8 fade-in-up hidden">
            <h2 class="text-3xl font-light mb-8 text-[#A3F3C5]">Job Completion</h2>
            
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Job Name</label>
                <input type="text" id="jobName" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="Enter job name">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Kit Name/Type</label>
                <input type="text" id="compKitName" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="Enter kit type">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Total Kits Completed</label>
                <input type="number" id="kitsCompleted" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="1">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Number of Bodies Used</label>
                <input type="number" id="bodiesUsed" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="1">
              </div>

              <div>
                <label class="block text-sm font-medium text-[#9D9F9E] mb-2">Total Hours Spent</label>
                <input type="number" id="hoursSpent" 
                  class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                  placeholder="0" min="0.1" step="0.1">
              </div>

              <button onclick="calculateCompletion()" 
                class="w-full bg-[#A3F3C5] hover:bg-[#8cd9ad] text-[#0D2D53] font-medium py-4 rounded-xl transition-all transform hover:scale-[1.02] glow">
                Calculate Performance
              </button>
            </div>
          </div>

          <!-- History View -->
          <div id="historyView" class="glass rounded-3xl p-8 fade-in-up hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-light text-[#A3F3C5]">History</h2>
              <div class="flex gap-3">
                <button onclick="filterHistory('all')" id="filterAll" class="px-4 py-2 rounded-lg bg-[#A3F3C5] text-[#0D2D53] text-sm font-medium">
                  All
                </button>
                <button onclick="filterHistory('Projection')" id="filterProjection" class="px-4 py-2 rounded-lg bg-[#1e2223] text-[#9D9F9E] text-sm font-medium hover:bg-[#2a2e2f]">
                  Projections
                </button>
                <button onclick="filterHistory('Completion')" id="filterCompletion" class="px-4 py-2 rounded-lg bg-[#1e2223] text-[#9D9F9E] text-sm font-medium hover:bg-[#2a2e2f]">
                  Completions
                </button>
              </div>
            </div>

            <div class="mb-6">
              <input type="text" id="searchHistory" 
                onkeyup="searchHistory()"
                class="w-full bg-[#1e2223] border border-[#2a2e2f] rounded-xl px-4 py-3 text-white focus:border-[#A3F3C5] focus:outline-none transition-colors"
                placeholder="Search by job/project name...">
            </div>

            <div id="historyLoading" class="text-center py-12 text-[#9D9F9E]">
              Loading history...
            </div>

            <div id="historyResults" class="space-y-4 hidden">
              <!-- History items will be inserted here -->
            </div>

            <div id="historyEmpty" class="text-center py-12 text-[#9D9F9E] hidden">
              <div class="text-5xl mb-4">üìã</div>
              <p>No history found. Start by creating projections or logging completions.</p>
            </div>
          </div>

          <!-- Results Panel -->
          <div class="space-y-6">
            <!-- Summary Cards - Projections -->
            <div id="resultsPanel" class="hidden space-y-6 fade-in-up">
              
              <!-- Key Metrics -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-3xl font-light mb-6 text-[#A3F3C5]">Labor Requirements</h2>
                
                <div class="grid grid-cols-2 gap-6">
                  <div class="bg-[#1e2223] rounded-xl p-6">
                    <div class="text-[#9D9F9E] text-sm mb-2">Bodies Needed</div>
                    <div class="text-4xl font-light text-white" id="bodiesNeeded">0</div>
                  </div>
                  
                  <div class="bg-[#1e2223] rounded-xl p-6">
                    <div class="text-[#9D9F9E] text-sm mb-2">Total Hours</div>
                    <div class="text-4xl font-light text-white" id="totalHours">0</div>
                  </div>
                </div>
              </div>

              <!-- Financial Summary -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-3xl font-light mb-6 text-[#A3F3C5]">Financial Summary</h2>
                
                <div class="space-y-4">
                  <div class="flex justify-between items-center py-3 border-b border-[#2a2e2f]">
                    <span class="text-[#9D9F9E]">Labor Cost</span>
                    <span class="text-2xl font-light text-white" id="laborCost">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center py-3 border-b border-[#2a2e2f]">
                    <span class="text-[#9D9F9E]">Revenue (@ $0.50/kit)</span>
                    <span class="text-2xl font-light text-white" id="revenue">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center py-4 mt-4">
                    <span class="text-xl font-medium">Net Profit/Loss</span>
                    <span class="text-3xl font-light" id="netProfit">$0.00</span>
                  </div>
                </div>
              </div>

              <!-- Profitability Chart -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-2xl font-light mb-6 text-[#A3F3C5]">Profitability Analysis</h2>
                <canvas id="profitChart" class="w-full" height="200"></canvas>
              </div>

              <!-- Additional Metrics -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-2xl font-light mb-6 text-[#A3F3C5]">Project Details</h2>
                
                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Cost per Kit</span>
                    <span class="text-lg text-white" id="costPerKit">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Profit per Kit</span>
                    <span class="text-lg text-white" id="profitPerKit">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Profit Margin</span>
                    <span class="text-lg text-white" id="profitMargin">0%</span>
                  </div>

                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Kits per Day (per person)</span>
                    <span class="text-lg text-white" id="kitsPerDay">0</span>
                  </div>

                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Total Kits per Day (all staff)</span>
                    <span class="text-lg text-white" id="totalKitsPerDay">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Summary Cards - Completion -->
            <div id="completionResults" class="hidden space-y-6 fade-in-up">
              
              <!-- Performance Metrics -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-3xl font-light mb-6 text-[#A3F3C5]">Performance Metrics</h2>
                
                <div class="grid grid-cols-2 gap-6">
                  <div class="bg-[#1e2223] rounded-xl p-6">
                    <div class="text-[#9D9F9E] text-sm mb-2">Kits per Body per Hour</div>
                    <div class="text-4xl font-light text-white" id="kitsPerBodyPerHour">0</div>
                  </div>
                  
                  <div class="bg-[#1e2223] rounded-xl p-6">
                    <div class="text-[#9D9F9E] text-sm mb-2">Hours per Kit</div>
                    <div class="text-4xl font-light text-white" id="hoursPerKit">0</div>
                  </div>
                </div>
              </div>

              <!-- Financial Summary - Completion -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-3xl font-light mb-6 text-[#A3F3C5]">Financial Summary</h2>
                
                <div class="space-y-4">
                  <div class="flex justify-between items-center py-3 border-b border-[#2a2e2f]">
                    <span class="text-[#9D9F9E]">Actual Labor Cost</span>
                    <span class="text-2xl font-light text-white" id="compLaborCost">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center py-3 border-b border-[#2a2e2f]">
                    <span class="text-[#9D9F9E]">Revenue (@ $0.50/kit)</span>
                    <span class="text-2xl font-light text-white" id="compRevenue">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center py-4 mt-4">
                    <span class="text-xl font-medium">Net Profit/Loss</span>
                    <span class="text-3xl font-light" id="compNetProfit">$0.00</span>
                  </div>
                </div>
              </div>

              <!-- Profitability Chart - Completion -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-2xl font-light mb-6 text-[#A3F3C5]">Actual Performance</h2>
                <canvas id="compProfitChart" class="w-full" height="200"></canvas>
              </div>

              <!-- Job Details -->
              <div class="glass rounded-3xl p-8">
                <h2 class="text-2xl font-light mb-6 text-[#A3F3C5]">Job Details</h2>
                
                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Cost per Kit</span>
                    <span class="text-lg text-white" id="compCostPerKit">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Profit per Kit</span>
                    <span class="text-lg text-white" id="compProfitPerKit">$0.00</span>
                  </div>
                  
                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Profit Margin</span>
                    <span class="text-lg text-white" id="compProfitMargin">0%</span>
                  </div>

                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Total Kits Completed</span>
                    <span class="text-lg text-white" id="compTotalKits">0</span>
                  </div>

                  <div class="flex justify-between items-center">
                    <span class="text-[#9D9F9E]">Average Hours per Body</span>
                    <span class="text-lg text-white" id="avgHoursPerBody">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Initial State Message -->
            <div id="initialMessage" class="glass rounded-3xl p-12 text-center">
              <div class="text-6xl mb-6">üìä</div>
              <h3 class="text-2xl font-light text-[#A3F3C5] mb-4">Ready to Calculate</h3>
              <p class="text-[#9D9F9E]">Enter your project details and click Calculate to see labor requirements and profitability projections.</p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbzpFY7d3ODtxmK0734twn2STo_UBudb_Eg3qZzys_dnqJxzr1aZw7zU0sFSfUgUJErv/exec';
    
    const LABOR_COST_PER_HOUR = 18.20;
    const PROFIT_PER_KIT = 0.50;
    let profitChart = null;
    let compProfitChart = null;
    let currentMode = 'projection';
    let currentFilter = 'all';
    let historyData = [];

    function switchMode(mode) {
      currentMode = mode;
      
      // Update button styles
      const projectionBtn = document.getElementById('projectionBtn');
      const completionBtn = document.getElementById('completionBtn');
      const historyBtn = document.getElementById('historyBtn');
      
      // Reset all buttons
      projectionBtn.className = 'px-8 py-3 rounded-full font-medium transition-all text-[#9D9F9E] hover:text-white';
      completionBtn.className = 'px-8 py-3 rounded-full font-medium transition-all text-[#9D9F9E] hover:text-white';
      historyBtn.className = 'px-8 py-3 rounded-full font-medium transition-all text-[#9D9F9E] hover:text-white';
      
      // Hide all views
      document.getElementById('projectionsForm').classList.add('hidden');
      document.getElementById('completionForm').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('resultsPanel').classList.add('hidden');
      document.getElementById('completionResults').classList.add('hidden');
      document.getElementById('initialMessage').classList.add('hidden');
      
      if (mode === 'projection') {
        projectionBtn.className = 'px-8 py-3 rounded-full font-medium transition-all bg-[#A3F3C5] text-[#0D2D53]';
        document.getElementById('projectionsForm').classList.remove('hidden');
        document.getElementById('initialMessage').classList.remove('hidden');
      } else if (mode === 'completion') {
        completionBtn.className = 'px-8 py-3 rounded-full font-medium transition-all bg-[#A3F3C5] text-[#0D2D53]';
        document.getElementById('completionForm').classList.remove('hidden');
        document.getElementById('initialMessage').classList.remove('hidden');
      } else if (mode === 'history') {
        historyBtn.className = 'px-8 py-3 rounded-full font-medium transition-all bg-[#A3F3C5] text-[#0D2D53]';
        document.getElementById('historyView').classList.remove('hidden');
        loadHistory();
      }
    }

    function calculateProjections() {
      // Get input values
      const projectName = document.getElementById('projectName').value;
      const kitName = document.getElementById('kitName').value;
      const totalKits = parseFloat(document.getElementById('totalKits').value);
      const kitsPerHour = parseFloat(document.getElementById('kitsPerHour').value);
      const numDays = parseFloat(document.getElementById('numDays').value);
      const hoursPerDay = parseFloat(document.getElementById('hoursPerDay').value);

      // Validate inputs
      if (!projectName || !kitName || !totalKits || !kitsPerHour || !numDays || !hoursPerDay) {
        alert('Please fill in all fields');
        return;
      }

      if (totalKits <= 0 || kitsPerHour <= 0 || numDays <= 0 || hoursPerDay <= 0) {
        alert('All numeric values must be greater than 0');
        return;
      }

      // Calculate total available hours per person
      const totalHoursAvailable = numDays * hoursPerDay;
      
      // Calculate kits one person can make in available time
      const kitsPerPerson = kitsPerHour * totalHoursAvailable;
      
      // Calculate number of bodies needed (round up)
      const bodiesNeeded = Math.ceil(totalKits / kitsPerPerson);
      
      // Calculate total hours needed
      const totalHours = bodiesNeeded * totalHoursAvailable;
      
      // Calculate labor cost
      const laborCost = totalHours * LABOR_COST_PER_HOUR;
      
      // Calculate revenue
      const revenue = totalKits * PROFIT_PER_KIT;
      
      // Calculate net profit/loss
      const netProfit = revenue - laborCost;
      
      // Calculate per-kit metrics
      const costPerKit = laborCost / totalKits;
      const profitPerKit = (revenue - laborCost) / totalKits;
      const profitMargin = (profitPerKit / PROFIT_PER_KIT) * 100;
      
      // Calculate daily metrics
      const kitsPerDayPerPerson = kitsPerHour * hoursPerDay;
      const totalKitsPerDay = kitsPerDayPerPerson * bodiesNeeded;

      // Update UI
      document.getElementById('bodiesNeeded').textContent = bodiesNeeded;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('laborCost').textContent = `$${laborCost.toFixed(2)}`;
      document.getElementById('revenue').textContent = `$${revenue.toFixed(2)}`;
      
      // Update net profit with color
      const netProfitElement = document.getElementById('netProfit');
      netProfitElement.textContent = `$${netProfit.toFixed(2)}`;
      if (netProfit >= 0) {
        netProfitElement.className = 'text-3xl font-light text-[#A3F3C5]';
      } else {
        netProfitElement.className = 'text-3xl font-light text-red-400';
      }
      
      document.getElementById('costPerKit').textContent = `$${costPerKit.toFixed(2)}`;
      document.getElementById('profitPerKit').textContent = `$${profitPerKit.toFixed(2)}`;
      document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
      document.getElementById('kitsPerDay').textContent = kitsPerDayPerPerson.toFixed(0);
      document.getElementById('totalKitsPerDay').textContent = totalKitsPerDay.toFixed(0);

      // Show results panel
      document.getElementById('initialMessage').classList.add('hidden');
      document.getElementById('resultsPanel').classList.remove('hidden');

      // Create/update chart
      createProfitChart(laborCost, revenue, netProfit);

      // Save projection data
      saveProjectionData({
        projectName,
        kitName,
        totalKits,
        bodiesNeeded,
        totalHours,
        kitsPerHour,
        laborCost,
        revenue,
        netProfit,
        costPerKit,
        profitPerKit,
        profitMargin,
        numDays,
        hoursPerDay
      });
    }

    function calculateCompletion() {
      // Get input values
      const jobName = document.getElementById('jobName').value;
      const compKitName = document.getElementById('compKitName').value;
      const kitsCompleted = parseFloat(document.getElementById('kitsCompleted').value);
      const bodiesUsed = parseFloat(document.getElementById('bodiesUsed').value);
      const hoursSpent = parseFloat(document.getElementById('hoursSpent').value);

      // Validate inputs
      if (!jobName || !compKitName || !kitsCompleted || !bodiesUsed || !hoursSpent) {
        alert('Please fill in all fields');
        return;
      }

      if (kitsCompleted <= 0 || bodiesUsed <= 0 || hoursSpent <= 0) {
        alert('All numeric values must be greater than 0');
        return;
      }

      // Calculate performance metrics
      const kitsPerBodyPerHour = kitsCompleted / (bodiesUsed * hoursSpent);
      const hoursPerKit = hoursSpent / kitsCompleted;
      
      // Calculate labor cost
      const laborCost = hoursSpent * LABOR_COST_PER_HOUR;
      
      // Calculate revenue
      const revenue = kitsCompleted * PROFIT_PER_KIT;
      
      // Calculate net profit/loss
      const netProfit = revenue - laborCost;
      
      // Calculate per-kit metrics
      const costPerKit = laborCost / kitsCompleted;
      const profitPerKit = (revenue - laborCost) / kitsCompleted;
      const profitMargin = (profitPerKit / PROFIT_PER_KIT) * 100;
      
      // Calculate average hours per body
      const avgHoursPerBody = hoursSpent / bodiesUsed;

      // Update UI
      document.getElementById('kitsPerBodyPerHour').textContent = kitsPerBodyPerHour.toFixed(2);
      document.getElementById('hoursPerKit').textContent = hoursPerKit.toFixed(2);
      document.getElementById('compLaborCost').textContent = `$${laborCost.toFixed(2)}`;
      document.getElementById('compRevenue').textContent = `$${revenue.toFixed(2)}`;
      
      // Update net profit with color
      const netProfitElement = document.getElementById('compNetProfit');
      netProfitElement.textContent = `$${netProfit.toFixed(2)}`;
      if (netProfit >= 0) {
        netProfitElement.className = 'text-3xl font-light text-[#A3F3C5]';
      } else {
        netProfitElement.className = 'text-3xl font-light text-red-400';
      }
      
      document.getElementById('compCostPerKit').textContent = `$${costPerKit.toFixed(2)}`;
      document.getElementById('compProfitPerKit').textContent = `$${profitPerKit.toFixed(2)}`;
      document.getElementById('compProfitMargin').textContent = `${profitMargin.toFixed(1)}%`;
      document.getElementById('compTotalKits').textContent = kitsCompleted.toFixed(0);
      document.getElementById('avgHoursPerBody').textContent = avgHoursPerBody.toFixed(1);

      // Show results panel
      document.getElementById('initialMessage').classList.add('hidden');
      document.getElementById('completionResults').classList.remove('hidden');

      // Create/update chart
      createCompletionChart(laborCost, revenue, netProfit);

      // Save completion data
      saveCompletionData({
        jobName,
        kitName: compKitName,
        kitsCompleted,
        bodiesUsed,
        hoursSpent,
        kitsPerBodyPerHour,
        hoursPerKit,
        laborCost,
        revenue,
        netProfit,
        costPerKit,
        profitPerKit,
        profitMargin
      });
    }

    function createProfitChart(laborCost, revenue, netProfit) {
      const ctx = document.getElementById('profitChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (profitChart) {
        profitChart.destroy();
      }

      const isProfitable = netProfit >= 0;
      
      profitChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Labor Cost', 'Revenue', 'Net Profit/Loss'],
          datasets: [{
            label: 'Amount ($)',
            data: [laborCost, revenue, Math.abs(netProfit)],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(163, 243, 197, 0.7)',
              isProfitable ? 'rgba(163, 243, 197, 0.9)' : 'rgba(255, 99, 132, 0.9)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(163, 243, 197, 1)',
              isProfitable ? 'rgba(163, 243, 197, 1)' : 'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: isProfitable ? '‚úì PROJECT IS PROFITABLE' : '‚úó PROJECT WILL LOSE MONEY',
              color: isProfitable ? '#A3F3C5' : '#ff6384',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: {
                bottom: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9D9F9E',
                callback: function(value) {
                  return '$' + value.toFixed(0);
                }
              },
              grid: {
                color: 'rgba(163, 243, 197, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#9D9F9E'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function createCompletionChart(laborCost, revenue, netProfit) {
      const ctx = document.getElementById('compProfitChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (compProfitChart) {
        compProfitChart.destroy();
      }

      const isProfitable = netProfit >= 0;
      
      compProfitChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Actual Labor Cost', 'Revenue', 'Net Profit/Loss'],
          datasets: [{
            label: 'Amount ($)',
            data: [laborCost, revenue, Math.abs(netProfit)],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(163, 243, 197, 0.7)',
              isProfitable ? 'rgba(163, 243, 197, 0.9)' : 'rgba(255, 99, 132, 0.9)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(163, 243, 197, 1)',
              isProfitable ? 'rgba(163, 243, 197, 1)' : 'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: isProfitable ? '‚úì JOB WAS PROFITABLE' : '‚úó JOB LOST MONEY',
              color: isProfitable ? '#A3F3C5' : '#ff6384',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: {
                bottom: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9D9F9E',
                callback: function(value) {
                  return '$' + value.toFixed(0);
                }
              },
              grid: {
                color: 'rgba(163, 243, 197, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#9D9F9E'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Auto-calculate on input change for projections (optional)
    const projInputs = ['totalKits', 'kitsPerHour', 'numDays', 'hoursPerDay'];
    projInputs.forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        const projectName = document.getElementById('projectName').value;
        const kitName = document.getElementById('kitName').value;
        if (projectName && kitName) {
          calculateProjections();
        }
      });
    });

    // ===== DATA PERSISTENCE FUNCTIONS =====

    async function saveProjectionData(data) {
      if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        console.warn('API URL not configured. Data not saved.');
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveProjection',
            ...data
          })
        });
        
        console.log('Projection saved successfully');
      } catch (error) {
        console.error('Error saving projection:', error);
      }
    }

    async function saveCompletionData(data) {
      if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        console.warn('API URL not configured. Data not saved.');
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveCompletion',
            ...data
          })
        });
        
        console.log('Completion saved successfully');
      } catch (error) {
        console.error('Error saving completion:', error);
      }
    }

    async function loadHistory() {
      if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        document.getElementById('historyLoading').classList.add('hidden');
        document.getElementById('historyEmpty').classList.remove('hidden');
        document.getElementById('historyEmpty').innerHTML = `
          <div class="text-5xl mb-4">‚öôÔ∏è</div>
          <p class="text-xl mb-2">API Not Configured</p>
          <p class="text-sm">Please set your Google Apps Script URL in the code to enable history.</p>
        `;
        return;
      }

      document.getElementById('historyLoading').classList.remove('hidden');
      document.getElementById('historyResults').classList.add('hidden');
      document.getElementById('historyEmpty').classList.add('hidden');

      try {
        const response = await fetch(`${API_URL}?action=getHistory&type=${currentFilter}&limit=50`);
        const result = await response.json();

        if (result.status === 'success' && result.data && result.data.length > 0) {
          historyData = result.data;
          renderHistory(historyData);
        } else {
          document.getElementById('historyLoading').classList.add('hidden');
          document.getElementById('historyEmpty').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('historyLoading').classList.add('hidden');
        document.getElementById('historyEmpty').classList.remove('hidden');
        document.getElementById('historyEmpty').innerHTML = `
          <div class="text-5xl mb-4">‚ö†Ô∏è</div>
          <p class="text-xl mb-2">Error Loading History</p>
          <p class="text-sm">Please check your API configuration and try again.</p>
        `;
      }
    }

    function renderHistory(data) {
      document.getElementById('historyLoading').classList.add('hidden');
      document.getElementById('historyEmpty').classList.add('hidden');
      document.getElementById('historyResults').classList.remove('hidden');

      const container = document.getElementById('historyResults');
      container.innerHTML = '';

      if (data.length === 0) {
        document.getElementById('historyResults').classList.add('hidden');
        document.getElementById('historyEmpty').classList.remove('hidden');
        return;
      }

      data.forEach(item => {
        const date = new Date(item.Timestamp);
        const isProfitable = parseFloat(item['Net Profit']) >= 0;
        const profitClass = isProfitable ? 'text-[#A3F3C5]' : 'text-red-400';
        const typeColor = item.Type === 'Projection' ? 'bg-blue-500' : 'bg-[#A3F3C5]';

        const card = document.createElement('div');
        card.className = 'bg-[#1e2223] rounded-xl p-6 hover:border hover:border-[#A3F3C5] transition-all cursor-pointer';
        card.onclick = () => viewHistoryDetail(item);

        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <span class="${typeColor} text-[#0D2D53] text-xs font-bold px-3 py-1 rounded-full">${item.Type}</span>
                <span class="text-[#9D9F9E] text-sm">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
              </div>
              <h3 class="text-xl font-light text-white">${item['Project/Job Name']}</h3>
              <p class="text-[#9D9F9E]">${item['Kit Name']}</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-light ${profitClass}">${isProfitable ? '+' : ''}$${parseFloat(item['Net Profit']).toFixed(2)}</div>
              <div class="text-sm text-[#9D9F9E]">${parseFloat(item['Profit Margin %']).toFixed(1)}% margin</div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-4 text-sm">
            <div>
              <span class="text-[#9D9F9E]">Kits:</span>
              <span class="text-white font-medium ml-2">${parseFloat(item['Total Kits']).toFixed(0)}</span>
            </div>
            <div>
              <span class="text-[#9D9F9E]">Bodies:</span>
              <span class="text-white font-medium ml-2">${parseFloat(item['Bodies Used/Needed']).toFixed(0)}</span>
            </div>
            <div>
              <span class="text-[#9D9F9E]">Hours:</span>
              <span class="text-white font-medium ml-2">${parseFloat(item['Total Hours']).toFixed(1)}</span>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function viewHistoryDetail(item) {
      // Create modal or detail view
      alert(`Full details for: ${item['Project/Job Name']}\n\nType: ${item.Type}\nKits: ${item['Total Kits']}\nLabor Cost: $${parseFloat(item['Labor Cost']).toFixed(2)}\nRevenue: $${parseFloat(item['Revenue']).toFixed(2)}\nNet Profit: $${parseFloat(item['Net Profit']).toFixed(2)}`);
    }

    function filterHistory(type) {
      currentFilter = type;

      // Update button styles
      document.getElementById('filterAll').className = type === 'all' 
        ? 'px-4 py-2 rounded-lg bg-[#A3F3C5] text-[#0D2D53] text-sm font-medium'
        : 'px-4 py-2 rounded-lg bg-[#1e2223] text-[#9D9F9E] text-sm font-medium hover:bg-[#2a2e2f]';
      document.getElementById('filterProjection').className = type === 'Projection'
        ? 'px-4 py-2 rounded-lg bg-[#A3F3C5] text-[#0D2D53] text-sm font-medium'
        : 'px-4 py-2 rounded-lg bg-[#1e2223] text-[#9D9F9E] text-sm font-medium hover:bg-[#2a2e2f]';
      document.getElementById('filterCompletion').className = type === 'Completion'
        ? 'px-4 py-2 rounded-lg bg-[#A3F3C5] text-[#0D2D53] text-sm font-medium'
        : 'px-4 py-2 rounded-lg bg-[#1e2223] text-[#9D9F9E] text-sm font-medium hover:bg-[#2a2e2f]';

      loadHistory();
    }

    function searchHistory() {
      const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
      
      if (searchTerm === '') {
        renderHistory(historyData);
        return;
      }

      const filtered = historyData.filter(item => {
        const name = (item['Project/Job Name'] || '').toLowerCase();
        const kit = (item['Kit Name'] || '').toLowerCase();
        return name.includes(searchTerm) || kit.includes(searchTerm);
      });

      renderHistory(filtered);
    }
  </script>
</body>
</html>
