<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Daily Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .gradient-bg {
      background: linear-gradient(-45deg, #0D2D53, #1a4d7a, #0D2D53, #164a6e);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    .floating {
      animation: float 6s ease-in-out infinite;
    }
    .fade-in-up {
      animation: fadeInUp 0.8s ease-out forwards;
    }
    .scale-in {
      animation: scaleIn 0.5s ease-out forwards;
    }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glow {
      box-shadow: 0 0 30px rgba(163, 243, 197, 0.3);
    }
    .input-focus:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(163, 243, 197, 0.3);
      border-color: #A3F3C5;
    }
    .grid-bg {
      background-image: 
        linear-gradient(rgba(163, 243, 197, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(163, 243, 197, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }
  </style>
</head>
<body class="bg-[#101314] text-[#EDEFED] overflow-x-hidden">
  <div id="app"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <script>
    let data = [];
    let currentIndex = 0;
    let needsRecount = false;
    let firstCount = null;
    let stats = {
      total: 0,
      matchedFirst: 0,
      requiredRecount: 0,
      matchedSecond: 0
    };
    let state = {
      stage: 'hero'
    };

    function handleFile(file) {
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.csv')) {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => processData(results.data)
        });
      } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const workbook = XLSX.read(e.target.result, { type: 'binary' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          processData(jsonData);
        };
        reader.readAsBinaryString(file);
      } else {
        showUploadStatus('Please upload a CSV or Excel file', 'error');
      }
    }

    function processData(rawData) {
      data = rawData.map(row => ({
        location: row.Location || row.location || '',
        locationOnHand: parseInt(row['Location On Hand'] || row['location on hand'] || row.location_on_hand || 0),
        scannedLocation: '',
        firstCount: null,
        secondCount: null,
        variance: null
      })).filter(row => row.location);

      if (data.length === 0) {
        showUploadStatus('No valid data found. Make sure your file has "Location" and "Location On Hand" columns', 'error');
        return;
      }

      stats.total = data.length;
      showUploadStatus(`‚úÖ Loaded ${data.length} locations successfully!`, 'success');
      
      setTimeout(() => {
        state.stage = 'scan';
        startCounting();
        render();
      }, 1500);
    }

    function showUploadStatus(message, type) {
      const statusDiv = document.getElementById('uploadStatus');
      const colors = {
        success: 'bg-green-900/20 border-green-500 text-green-400',
        error: 'bg-red-900/20 border-red-500 text-red-400'
      };
      statusDiv.innerHTML = `<div class="${colors[type]} border px-5 py-4 rounded-xl mt-6">${message}</div>`;
    }

    function startCounting() {
      currentIndex = 0;
      needsRecount = false;
      updateProgress();
      displayTargetLocation();
    }

    function updateProgress() {
      const progress = ((currentIndex / data.length) * 100).toFixed(0);
      const fills = document.querySelectorAll('.progress-fill');
      fills.forEach(fill => fill.style.width = progress + '%');
      
      const texts = document.querySelectorAll('.progress-text');
      texts.forEach(text => text.textContent = `Location ${currentIndex + 1} of ${data.length}`);
    }

    function displayTargetLocation() {
      const current = data[currentIndex];
      document.getElementById('targetLocation').textContent = current.location;
      document.getElementById('locationOnHandDisplay').innerHTML = `<strong>Location On Hand:</strong> ${current.locationOnHand}`;
    }

    function verifyLocation() {
      const scannedLocation = document.getElementById('scanInput').value.trim();
      const current = data[currentIndex];

      if (!scannedLocation) {
        showAlert('scanAlert', '‚ö†Ô∏è Please scan a location', 'error');
        return;
      }

      if (scannedLocation.toUpperCase() !== current.location.toUpperCase()) {
        showAlert('scanAlert', `‚ùå Wrong location! Expected: ${current.location}`, 'error');
        document.getElementById('scanInput').classList.add('animate-shake');
        setTimeout(() => document.getElementById('scanInput').classList.remove('animate-shake'), 400);
        document.getElementById('scanInput').value = '';
        document.getElementById('scanInput').focus();
        return;
      }

      current.scannedLocation = scannedLocation;
      showAlert('scanAlert', '‚úÖ Location verified!', 'success');
      
      setTimeout(() => {
        document.getElementById('scanInput').value = '';
        state.stage = 'count';
        displayCountingScreen();
        render();
      }, 800);
    }

    function displayCountingScreen() {
      const current = data[currentIndex];
      setTimeout(() => {
        document.getElementById('currentLocation').textContent = current.location;
        document.getElementById('locationOnHandDisplay2').innerHTML = `<strong>Location On Hand:</strong> ${current.locationOnHand}`;
        
        if (needsRecount) {
          document.getElementById('countLabel').textContent = '‚ö†Ô∏è Recount Required - Enter Count Again';
          showAlert('countAlert', `First count (${firstCount}) didn't match location on hand (${current.locationOnHand}). Please count again.`, 'warning');
        } else {
          document.getElementById('countLabel').textContent = 'üì¶ Enter Physical Count';
          document.getElementById('countAlert').innerHTML = '';
        }
        document.getElementById('countInput').focus();
      }, 100);
    }

    function submitCount() {
      const count = parseInt(document.getElementById('countInput').value);
      const current = data[currentIndex];

      if (isNaN(count) || count < 0) {
        showAlert('countAlert', '‚ö†Ô∏è Please enter a valid count', 'error');
        return;
      }

      if (!needsRecount) {
        current.firstCount = count;
        firstCount = count;

        if (count === current.locationOnHand) {
          stats.matchedFirst++;
          current.variance = 0;
          showAlert('countAlert', '‚úÖ Count matches location on hand!', 'success');
          
          setTimeout(() => {
            moveToNextLocation();
          }, 1000);
        } else {
          stats.requiredRecount++;
          needsRecount = true;
          document.getElementById('countInput').value = '';
          displayCountingScreen();
        }
      } else {
        current.secondCount = count;
        
        if (count === current.locationOnHand) {
          stats.matchedSecond++;
          current.variance = 0;
          showAlert('countAlert', '‚úÖ Second count matches!', 'success');
        } else {
          current.variance = count - current.locationOnHand;
          showAlert('countAlert', `‚ö†Ô∏è Variance: ${current.variance > 0 ? '+' : ''}${current.variance}`, 'warning');
        }

        setTimeout(() => {
          moveToNextLocation();
        }, 1200);
      }
    }

    function moveToNextLocation() {
      currentIndex++;
      needsRecount = false;
      firstCount = null;
      document.getElementById('countInput').value = '';

      if (currentIndex >= data.length) {
        state.stage = 'complete';
        displaySummary();
        render();
      } else {
        state.stage = 'scan';
        updateProgress();
        displayTargetLocation();
        render();
      }
    }

    function displaySummary() {
      setTimeout(() => {
        document.getElementById('totalLocations').textContent = stats.total;
        document.getElementById('matchedFirst').textContent = stats.matchedFirst;
        document.getElementById('requiredRecount').textContent = stats.requiredRecount;
        document.getElementById('matchedSecond').textContent = stats.matchedSecond;
      }, 100);
    }

    function downloadResults() {
      const exportData = data.map(row => ({
        Location: row.location,
        Scanned_Location: row.scannedLocation,
        Location_On_Hand: row.locationOnHand,
        First_Count: row.firstCount,
        Second_Count: row.secondCount || '',
        Variance: row.variance !== null ? row.variance : '',
        Status: row.variance === 0 ? 'Match' : 'Variance'
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Cycle Count Results');
      
      const timestamp = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `Cycle_Count_Results_${timestamp}.xlsx`);
    }

    function showAlert(elementId, message, type) {
      const colors = {
        success: 'bg-green-900/20 border-green-500 text-green-400',
        error: 'bg-red-900/20 border-red-500 text-red-400',
        warning: 'bg-yellow-900/20 border-yellow-500 text-yellow-400'
      };
      document.getElementById(elementId).innerHTML = `<div class="${colors[type]} border-l-4 px-5 py-4 rounded-xl mb-6">${message}</div>`;
    }

    function goBack() {
      if (confirm('Are you sure you want to go back to the beginning? All progress will be lost.')) {
        resetApp();
      }
    }

    function resetApp() {
      data = [];
      currentIndex = 0;
      needsRecount = false;
      firstCount = null;
      stats = { total: 0, matchedFirst: 0, requiredRecount: 0, matchedSecond: 0 };
      state.stage = 'hero';
      render();
    }

    function setupUploadZone() {
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      uploadZone.addEventListener('click', () => fileInput.click());

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('border-[#A3F3C5]', 'bg-[#1e2223]');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('border-[#A3F3C5]', 'bg-[#1e2223]');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-[#A3F3C5]', 'bg-[#1e2223]');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      });
    }

    function render() {
      const app = document.getElementById('app');
      let content = '';

      if (state.stage === 'hero') {
        content = `
          <div class="min-h-screen gradient-bg grid-bg relative overflow-hidden">
            <div class="absolute top-20 left-10 w-72 h-72 bg-[#A3F3C5] opacity-10 rounded-full blur-3xl floating"></div>
            <div class="absolute bottom-20 right-10 w-96 h-96 bg-[#A3F3C5] opacity-10 rounded-full blur-3xl floating" style="animation-delay: -3s;"></div>
            
            <div class="relative z-10 flex items-center justify-center min-h-screen px-6">
              <div class="max-w-5xl w-full text-center fade-in-up">
                <div class="inline-block px-6 py-2 glass rounded-full text-[#A3F3C5] text-lg font-medium tracking-widest uppercase mb-8 glow">
                  Operations Reporting Platform
                </div>
                
                <h1 class="text-7xl md:text-8xl lg:text-9xl font-extralight leading-none tracking-tight mb-8 bg-gradient-to-r from-white to-[#A3F3C5] bg-clip-text text-transparent">
                  Daily Cycle<br/>Count
                </h1>
                
                <p class="text-2xl text-[#9D9F9E] max-w-3xl mx-auto mb-12 font-light leading-relaxed">
                  "Inventory is our customers' livelihood, we are their bank"
                </p>
                
                <button onclick="state.stage = 'upload'; render();" class="group relative bg-[#A3F3C5] text-[#101314] px-12 py-5 rounded-2xl text-xl font-medium hover:bg-[#8de0ad] transition-all glow hover:scale-105 transform">
                  <span class="relative z-10">Start Your Count</span>
                  <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 rounded-2xl transition-opacity"></div>
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'upload') {
        content = `
          <div class="min-h-screen gradient-bg grid-bg px-6 py-20">
            <div class="max-w-4xl mx-auto">
              <div class="text-center mb-12 fade-in-up">
                <h2 class="text-6xl font-light mb-4 bg-gradient-to-r from-white to-[#A3F3C5] bg-clip-text text-transparent">Upload File</h2>
                <p class="text-[#9D9F9E] text-lg">Upload your inventory file to begin</p>
              </div>
              
              <div class="glass rounded-3xl p-10 scale-in">
                <div class="mb-6">
                  <button onclick="state.stage = 'hero'; render();" class="text-[#9D9F9E] hover:text-[#A3F3C5] transition-colors text-sm flex items-center gap-2">
                    <span>‚Üê</span> Back
                  </button>
                </div>
                <div id="uploadZone" class="border-3 border-dashed border-[#2a2d2e] rounded-2xl p-16 text-center cursor-pointer transition-all hover:border-[#A3F3C5] hover:bg-[#1a1d1e]">
                  <div class="text-6xl mb-6">üìä</div>
                  <p class="text-xl font-medium text-[#EDEFED] mb-4">Click to upload or drag & drop your file</p>
                  <p class="text-[#9D9F9E]">Excel file with Location and Location On Hand columns</p>
                  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden">
                </div>
                <div id="uploadStatus"></div>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'scan') {
        content = `
          <div class="min-h-screen gradient-bg grid-bg px-6 py-20">
            <div class="max-w-4xl mx-auto">
              <div class="glass rounded-3xl p-10 scale-in">
                <div class="bg-gradient-to-r from-[#0D2D53] to-[#1a4d7a] rounded-2xl p-12 mb-8 text-center relative overflow-hidden">
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#0D2D53] via-[#A3F3C5] to-[#0D2D53]"></div>
                  <div class="text-sm text-[#A3F3C5] uppercase tracking-widest font-bold mb-4">Target Location</div>
                  <div id="targetLocation" class="text-6xl font-bold text-white mb-6 font-mono tracking-wider"></div>
                  <div id="locationOnHandDisplay" class="text-lg text-[#EDEFED] bg-white/10 backdrop-blur-sm rounded-xl py-4 px-6 inline-block"></div>
                </div>

                <div class="bg-[#1a1d1e] rounded-xl p-4 mb-8">
                  <div class="h-3 bg-[#2a2d2e] rounded-full overflow-hidden">
                    <div class="progress-fill h-full bg-gradient-to-r from-[#0D2D53] via-[#1a4d7a] to-[#A3F3C5] transition-all duration-500 rounded-full"></div>
                  </div>
                  <div class="progress-text text-center text-[#9D9F9E] text-sm font-semibold mt-3"></div>
                </div>

                <div id="scanAlert"></div>

                <div class="space-y-3 mb-6">
                  <label class="block text-sm font-medium text-[#9D9F9E] uppercase tracking-wide">üîç Scan Location Barcode</label>
                  <input type="text" id="scanInput" class="w-full bg-[#1a1d1e] border-2 border-[#2a2d2e] rounded-xl px-6 py-5 text-[#EDEFED] text-2xl font-mono text-center input-focus transition-all" placeholder="Scan or type location..." autofocus>
                </div>

                <button onclick="verifyLocation()" class="w-full bg-[#A3F3C5] text-[#101314] py-5 rounded-xl font-semibold text-lg hover:bg-[#8de0ad] transition-all glow hover:scale-105 transform mb-4">
                  ‚úì Verify Location
                </button>
                <button onclick="goBack()" class="w-full bg-[#2a2d2e] text-[#9D9F9E] py-4 rounded-xl font-medium hover:bg-[#3a3d3e] transition-all">
                  ‚Üê Back to Beginning
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'count') {
        content = `
          <div class="min-h-screen gradient-bg grid-bg px-6 py-20">
            <div class="max-w-4xl mx-auto">
              <div class="glass rounded-3xl p-10 scale-in">
                <div class="bg-gradient-to-r from-[#0D2D53] to-[#1a4d7a] rounded-2xl p-12 mb-8 text-center relative overflow-hidden">
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#0D2D53] via-[#A3F3C5] to-[#0D2D53]"></div>
                  <div class="text-sm text-[#A3F3C5] uppercase tracking-widest font-bold mb-4">Current Location</div>
                  <div id="currentLocation" class="text-6xl font-bold text-white mb-6 font-mono tracking-wider"></div>
                  <div id="locationOnHandDisplay2" class="text-lg text-[#EDEFED] bg-white/10 backdrop-blur-sm rounded-xl py-4 px-6 inline-block"></div>
                </div>

                <div class="bg-[#1a1d1e] rounded-xl p-4 mb-8">
                  <div class="h-3 bg-[#2a2d2e] rounded-full overflow-hidden">
                    <div class="progress-fill h-full bg-gradient-to-r from-[#0D2D53] via-[#1a4d7a] to-[#A3F3C5] transition-all duration-500 rounded-full"></div>
                  </div>
                  <div class="progress-text text-center text-[#9D9F9E] text-sm font-semibold mt-3"></div>
                </div>

                <div id="countAlert"></div>

                <div class="space-y-3 mb-6">
                  <label id="countLabel" class="block text-sm font-medium text-[#9D9F9E] uppercase tracking-wide">üì¶ Enter Physical Count</label>
                  <input type="number" id="countInput" class="w-full bg-[#1a1d1e] border-2 border-[#2a2d2e] rounded-xl px-6 py-5 text-[#EDEFED] text-2xl font-mono text-center input-focus transition-all" placeholder="0" min="0" autofocus>
                </div>

                <button onclick="submitCount()" class="w-full bg-[#A3F3C5] text-[#101314] py-5 rounded-xl font-semibold text-lg hover:bg-[#8de0ad] transition-all glow hover:scale-105 transform mb-4">
                  ‚úì Submit Count
                </button>
                <button onclick="goBack()" class="w-full bg-[#2a2d2e] text-[#9D9F9E] py-4 rounded-xl font-medium hover:bg-[#3a3d3e] transition-all">
                  ‚Üê Back to Beginning
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'complete') {
        content = `
          <div class="min-h-screen gradient-bg grid-bg px-6 py-20">
            <div class="max-w-5xl mx-auto">
              <div class="glass rounded-3xl p-16 scale-in text-center">
                <div class="text-8xl mb-8">üéâ</div>
                <h2 class="text-6xl font-light mb-12 bg-gradient-to-r from-white to-[#A3F3C5] bg-clip-text text-transparent">Cycle Count Complete!</h2>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                  <div class="glass rounded-2xl p-8 hover:scale-105 transition-transform">
                    <div class="text-sm text-[#9D9F9E] uppercase tracking-widest font-bold mb-3">Total Locations</div>
                    <div id="totalLocations" class="text-5xl font-bold text-[#A3F3C5]"></div>
                  </div>
                  <div class="glass rounded-2xl p-8 hover:scale-105 transition-transform">
                    <div class="text-sm text-[#9D9F9E] uppercase tracking-widest font-bold mb-3">Matched First</div>
                    <div id="matchedFirst" class="text-5xl font-bold text-[#A3F3C5]"></div>
                  </div>
                  <div class="glass rounded-2xl p-8 hover:scale-105 transition-transform">
                    <div class="text-sm text-[#9D9F9E] uppercase tracking-widest font-bold mb-3">Required Recount</div>
                    <div id="requiredRecount" class="text-5xl font-bold text-[#A3F3C5]"></div>
                  </div>
                  <div class="glass rounded-2xl p-8 hover:scale-105 transition-transform">
                    <div class="text-sm text-[#9D9F9E] uppercase tracking-widest font-bold mb-3">Matched Second</div>
                    <div id="matchedSecond" class="text-5xl font-bold text-[#A3F3C5]"></div>
                  </div>
                </div>

                <button onclick="downloadResults()" class="bg-[#A3F3C5] text-[#101314] px-12 py-5 rounded-2xl text-xl font-semibold hover:bg-[#8de0ad] transition-all glow hover:scale-105 transform mb-4">
                  üì• Download Results
                </button>
                <button onclick="resetApp()" class="block w-full text-[#9D9F9E] hover:text-[#A3F3C5] transition-colors mt-6">
                  üîÑ Start New Count
                </button>
              </div>
            </div>
          </div>
        `;
      }

      app.innerHTML = content;

      // Setup event listeners after render
      if (state.stage === 'upload') {
        setupUploadZone();
      }

      if (state.stage === 'scan') {
        setTimeout(() => {
          document.getElementById('scanInput').focus();
          document.getElementById('scanInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyLocation();
          });
        }, 100);
      }

      if (state.stage === 'count') {
        setTimeout(() => {
          document.getElementById('countInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitCount();
          });
        }, 100);
      }
    }

    // Initial render
    render();
  </script>
</body>
</html>