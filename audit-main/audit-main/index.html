<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atomix Audit - Daily Policy Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .gradient-bg {
      background: linear-gradient(-45deg, #0D2D53, #1a4d7a, #0D2D53, #164a6e);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    .grid-bg {
      background-image:
        linear-gradient(rgba(163, 243, 197, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(163, 243, 197, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }
    .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glow { box-shadow: 0 0 30px rgba(163, 243, 197, 0.3); }
  </style>
</head>

<body class="bg-[#101314] text-[#EDEFED]">
  <div class="min-h-screen gradient-bg grid-bg">
    <!-- Header -->
    <div class="sticky top-0 z-50 glass border-b border-[#A3F3C5]/20">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button onclick="window.location.href='../index.html'" class="text-[#A3F3C5] hover:text-white transition-colors">
            ← Back to OPPS
          </button>
          <div class="h-6 w-px bg-[#A3F3C5]/30"></div>
          <h1 class="text-2xl font-light">Inventory Policy Audit</h1>
        </div>
        <div class="text-sm text-[#9D9F9E]" id="currentDate"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-5xl mx-auto px-6 py-8">
      <!-- Metadata Section -->
      <div class="glass rounded-2xl p-6 mb-6 fade-in-up">
        <h2 class="text-xl font-light mb-4 text-[#A3F3C5]">Audit Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-[#9D9F9E] mb-2">Date</label>
            <input type="date" id="auditDate" class="w-full bg-[#1e2223] border border-[#A3F3C5]/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[#A3F3C5]" required>
          </div>
          <div>
            <label class="block text-sm text-[#9D9F9E] mb-2">Auditor Name</label>
            <input type="text" id="auditorName" class="w-full bg-[#1e2223] border border-[#A3F3C5]/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[#A3F3C5]" required>
          </div>
          <div>
            <label class="block text-sm text-[#9D9F9E] mb-2">Shift</label>
            <select id="shift" class="w-full bg-[#1e2223] border border-[#A3F3C5]/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[#A3F3C5]">
              <option value="Day">Day</option>
              <option value="Night">Night</option>
              <option value="Weekend">Weekend</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Audit Sections -->
      <div id="auditSections"></div>

      <!-- Submit Button -->
      <div class="glass rounded-2xl p-6 mt-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-2xl font-light mb-1">Compliance Score: <span id="complianceScore" class="text-[#A3F3C5]">0%</span></div>
            <div class="text-sm text-[#9D9F9E]"><span id="passCount">0</span> Pass / <span id="totalCount">0</span> Total</div>
          </div>
          <button onclick="submitAudit()" class="bg-[#A3F3C5] text-[#0D2D53] px-8 py-3 rounded-lg font-medium hover:bg-white transition-all transform hover:scale-105 glow">
            Submit Audit
          </button>
        </div>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="hidden glass rounded-2xl p-6 mt-6 border-2 border-[#A3F3C5]">
        <div class="text-center">
          <div class="text-4xl mb-2">✓</div>
          <div class="text-xl font-light text-[#A3F3C5]">Audit Submitted Successfully!</div>
          <div class="text-sm text-[#9D9F9E] mt-2">Data has been saved to Google Sheets</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Set current date
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    document.getElementById('auditDate').valueAsDate = new Date();

    // Audit questions organized by section
    const auditData = {
      'Location Compliance': [
        { id: 'L1', question: 'All physical locations match system locations?', evidence: 'System location verification report' },
        { id: 'L2', question: 'No floor storage outside preapproved sections?', evidence: 'Visual inspection confirmation' },
        { id: 'L3', question: 'Quarantine section contains only incorrect location inventory?', evidence: 'List of items in quarantine' },
        { id: 'L4', question: 'All locations contain only one SKU (no mixed)?', evidence: 'System location contents report' },
      ],
      'Receiving Compliance': [
        { id: 'R1', question: 'All inventory scheduled in Conduit before arrival?', evidence: 'Conduit schedule verification' },
        { id: 'R2', question: 'All master cases/pallets have ASN numbers?', evidence: 'ASN documentation log' },
        { id: 'R3', question: 'Mixed/open/damaged cases broken down and scanned by unit?', evidence: 'Unit scan logs' },
        { id: 'R4', question: 'All received inventory has RFID tags?', evidence: 'RFID scan verification' },
        { id: 'R5', question: 'All received inventory assigned to system locations?', evidence: 'System report: Zero pending receives' },
      ],
      'Cycle Count Compliance': [
        { id: 'C1', question: 'All cycle counts performed BLIND (quantities hidden)?', evidence: 'Counter signatures confirming blind count protocol' },
        { id: 'C2', question: 'All cycle counts had two independent counters?', evidence: 'Cycle count logs with both signatures' },
        { id: 'C3', question: 'Mismatched counts escalated to leads for recount?', evidence: 'Escalation log with lead signatures' },
        { id: 'C4', question: 'Inventory adjustments only after manager signoff + CX notification?', evidence: 'Manager approval and CX notification confirmation' },
        { id: 'C5', question: 'On track for 500+ locations counted this week?', evidence: 'Weekly cycle count report' },
      ],
      'Picking Accuracy': [
        { id: 'P1', question: 'All picks scan-confirmed (no manual entry)?', evidence: 'Pick accuracy report showing scan rate' },
        { id: 'P2', question: 'Mispicks investigated immediately (same shift)?', evidence: 'Mispick investigation log with timestamps' },
        { id: 'P3', question: 'Incorrect inventory moved to quarantine during picking?', evidence: 'Quarantine movement log with timestamps' },
        { id: 'P4', question: 'Mispicks quarantined and put away by EOD?', evidence: 'Mispick resolution log showing zero pending' },
      ],
      'Damaged Inventory': [
        { id: 'D1', question: 'Damaged inventory moved out of active locations immediately?', evidence: 'Timestamps: Discovery vs movement logs' },
        { id: 'D2', question: 'Damaged inventory scanned out/in (no manual adjustments)?', evidence: 'Transaction logs showing scan-out and scan-in' },
        { id: 'D3', question: 'Damaged inventory logged and CX notified by EOD?', evidence: 'Damage log and CX notification confirmation' },
      ],
      'Account Usage & Traceability': [
        { id: 'A1', question: 'All team members logged into their own accounts?', evidence: 'System audit log showing individual user activity' },
        { id: 'A2', question: 'All activities fully traceable to individual users?', evidence: 'Sample transaction report with user IDs' },
      ],
      'Reporting & Metrics': [
        { id: 'M1', question: 'Inventory accuracy calculated today?', evidence: 'Daily accuracy calculation worksheet' },
        { id: 'M2', question: 'All required reports available to Ops leadership?', evidence: 'Report dashboard with all 6 required reports' },
      ]
    };

    // Render audit sections
    function renderAudit() {
      const container = document.getElementById('auditSections');
      let html = '';
      let totalQuestions = 0;

      Object.entries(auditData).forEach(([section, questions]) => {
        html += `
          <div class="glass rounded-2xl p-6 mb-4 fade-in-up">
            <h3 class="text-xl font-light mb-4 text-[#A3F3C5]">${section}</h3>
            <div class="space-y-4">
        `;

        questions.forEach(q => {
          totalQuestions++;
          html += `
            <div class="bg-[#1e2223] rounded-lg p-4">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <div class="font-medium mb-1">${q.id}. ${q.question}</div>
                  <div class="text-xs text-[#9D9F9E] italic">${q.evidence}</div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs text-[#9D9F9E] mb-1">Status</label>
                  <select id="${q.id}_status" onchange="updateScore()" class="w-full bg-[#101314] border border-[#A3F3C5]/30 rounded px-3 py-2 text-sm focus:outline-none focus:border-[#A3F3C5]">
                    <option value="">-- Select --</option>
                    <option value="PASS">✓ PASS</option>
                    <option value="FAIL">✗ FAIL</option>
                    <option value="N/A">N/A</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-[#9D9F9E] mb-1">Notes / Action Required</label>
                  <input type="text" id="${q.id}_notes" class="w-full bg-[#101314] border border-[#A3F3C5]/30 rounded px-3 py-2 text-sm focus:outline-none focus:border-[#A3F3C5]" placeholder="Add notes...">
                </div>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      document.getElementById('totalCount').textContent = totalQuestions;
    }

    // Update compliance score
    function updateScore() {
      let passCount = 0;
      let totalAnswered = 0;

      Object.values(auditData).flat().forEach(q => {
        const status = document.getElementById(`${q.id}_status`).value;
        if (status === 'PASS' || status === 'FAIL') {
          totalAnswered++;
          if (status === 'PASS') passCount++;
        }
      });

      const percentage = totalAnswered > 0 ? Math.round((passCount / totalAnswered) * 100) : 0;
      document.getElementById('complianceScore').textContent = percentage + '%';
      document.getElementById('passCount').textContent = passCount;
    }

    // Submit audit to Google Sheets
    async function submitAudit() {
      const date = document.getElementById('auditDate').value;
      const auditor = document.getElementById('auditorName').value;
      const shift = document.getElementById('shift').value;

      if (!date || !auditor) {
        alert('Please fill in Date and Auditor Name');
        return;
      }

      // Collect all responses
      const responses = [];
      Object.entries(auditData).forEach(([section, questions]) => {
        questions.forEach(q => {
          const status = document.getElementById(`${q.id}_status`).value;
          const notes = document.getElementById(`${q.id}_notes`).value;
          
          responses.push({
            date,
            auditor,
            shift,
            section,
            questionId: q.id,
            question: q.question,
            status: status || 'Not Answered',
            notes
          });
        });
      });

      // Calculate summary stats
      const passCount = responses.filter(r => r.status === 'PASS').length;
      const failCount = responses.filter(r => r.status === 'FAIL').length;
      const totalAnswered = passCount + failCount;
      const complianceRate = totalAnswered > 0 ? ((passCount / totalAnswered) * 100).toFixed(1) : 0;

      // **IMPORTANT**: Replace this URL with your Google Apps Script Web App URL
      const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE';

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            summary: {
              date,
              auditor,
              shift,
              passCount,
              failCount,
              totalQuestions: responses.length,
              complianceRate
            },
            responses
          })
        });

        // Show success message
        document.getElementById('successMessage').classList.remove('hidden');
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

        // Reset form after 3 seconds
        setTimeout(() => {
          if (confirm('Audit submitted! Would you like to start a new audit?')) {
            location.reload();
          }
        }, 2000);

      } catch (error) {
        console.error('Error submitting audit:', error);
        alert('Error submitting audit. Please check the console and ensure your Google Script URL is configured correctly.');
      }
    }

    // Initialize
    renderAudit();
  </script>
</body>
</html>