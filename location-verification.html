<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Location Verification</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #101314;
      color: #EDEFED;
      overflow-x: hidden;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .gradient-bg {
      background: linear-gradient(-45deg, #0D2D53, #1a4d7a, #0D2D53, #164a6e);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    .floating { animation: float 6s ease-in-out infinite; }
    .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
    .scale-in { animation: scaleIn 0.5s ease-out forwards; }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    .slide-up { animation: slideUp 0.3s ease-out forwards; }
    .shake { animation: shake 0.5s ease-in-out; }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glow { box-shadow: 0 0 30px rgba(163, 243, 197, 0.3); }

    .grid-bg {
      background-image:
        linear-gradient(rgba(163, 243, 197, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(163, 243, 197, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .home-btn {
      position: fixed;
      top: 1.5rem;
      left: 1.5rem;
      z-index: 50;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      color: #A3F3C5;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    .home-btn:hover {
      background: #1e2223;
      transform: translateX(-5px);
    }

    .btn {
      padding: 1.25rem 3rem;
      border-radius: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      width: 100%;
    }
    .btn-primary { background: #A3F3C5; color: #101314; }
    .btn-primary:hover:not(:disabled) { background: #8de0ad; transform: scale(1.05); }
    .btn-secondary {
      background: #2a2d2e;
      color: #EDEFED;
      border: 1px solid #3a3d3e;
    }
    .btn-secondary:hover { background: #3a3d3e; border-color: #A3F3C5; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 56rem;
      width: 100%;
    }

    .title {
      font-size: 3.75rem;
      font-weight: 300;
      text-align: center;
      background: linear-gradient(to right, white, #A3F3C5);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }
    .subtitle {
      text-align: center;
      color: #9D9F9E;
      font-size: 1.125rem;
      margin-bottom: 3rem;
    }

    .input {
      width: 100%;
      padding: 1rem 1.5rem;
      background: #1a1d1e;
      border: 2px solid #2a2d2e;
      border-radius: 0.75rem;
      color: #EDEFED;
      font-size: 1.125rem;
      transition: all 0.3s;
    }
    .input:focus {
      outline: none;
      border-color: #A3F3C5;
      box-shadow: 0 0 0 3px rgba(163, 243, 197, 0.3);
    }
    .input-scan {
      font-size: 2rem;
      font-family: 'Courier New', monospace;
      text-align: center;
      text-transform: uppercase;
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid;
      font-weight: 500;
    }
    .alert-success {
      background: rgba(6, 78, 59, 0.3);
      border-color: #10b981;
      color: #34d399;
    }
    .alert-error {
      background: rgba(127, 29, 29, 0.3);
      border-color: #ef4444;
      color: #f87171;
    }
    .alert-warning {
      background: rgba(255, 159, 64, 0.2);
      border-color: #FF9F40;
      color: #FFB366;
    }

    .progress-bar {
      background: #2a2d2e;
      height: 0.75rem;
      border-radius: 100px;
      overflow: hidden;
      margin: 2rem 0 1rem;
    }
    .progress-fill {
      background: linear-gradient(90deg, #0D2D53, #1a4d7a, #A3F3C5);
      height: 100%;
      transition: width 0.5s;
    }

    .location-card {
      background: linear-gradient(135deg, #0D2D53, #1a4d7a);
      border-radius: 1rem;
      padding: 3rem 2rem;
      text-align: center;
      position: relative;
      margin-bottom: 2rem;
    }
    .location-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #0D2D53, #A3F3C5, #0D2D53);
    }
    .location-label {
      font-size: 0.875rem;
      color: #A3F3C5;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .location-value {
      font-size: 5rem;
      color: white;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      margin-bottom: 1rem;
      letter-spacing: 0.1em;
    }

    .choice-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .choice-card:hover {
      border-color: #A3F3C5;
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(163, 243, 197, 0.2);
    }
    .choice-icon { font-size: 4rem; margin-bottom: 1rem; }
    .choice-title { font-size: 1.75rem; font-weight: 600; color: #EDEFED; margin-bottom: 0.5rem; }
    .choice-desc { font-size: 1rem; color: #9D9F9E; }

    .queue-badge {
      display: inline-block;
      background: #FF6F00;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 700;
      margin-top: 0.5rem;
    }

    .calc-icon {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 4rem;
      height: 4rem;
      background: #A3F3C5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(163, 243, 197, 0.5);
      transition: all 0.3s;
      z-index: 100;
    }
    .calc-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(163, 243, 197, 0.7);
    }

    .calc-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    .calc-container {
      background: #1a1d1e;
      border-radius: 1.5rem;
      padding: 2rem;
      border: 2px solid #A3F3C5;
      max-width: 400px;
      width: 90%;
    }

    .calc-display {
      background: #101314;
      border: 2px solid #2a2d2e;
      border-radius: 0.5rem;
      padding: 1.5rem;
      font-size: 2.5rem;
      font-family: 'Courier New', monospace;
      text-align: right;
      margin-bottom: 1rem;
      color: #A3F3C5;
      min-height: 80px;
      word-break: break-all;
    }

    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
    .calc-btn {
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      border-radius: 0.75rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: #2a2d2e;
      color: #EDEFED;
    }
    .calc-btn:hover { background: #3a3d3e; transform: scale(1.05); }
    .calc-btn:active { transform: scale(0.95); }
    .calc-btn-clear { background: #ef4444; color: white; }
    .calc-btn-equals { background: #A3F3C5; color: #101314; font-weight: 700; }
    .calc-btn-close { background: #6b7280; color: white; grid-column: span 4; }

    .scan-input-section { display: flex; gap: 1rem; align-items: stretch; }
    .scan-input-wrapper { flex: 1; }
    .count-input-section { display: flex; gap: 1rem; align-items: stretch; }
    .count-input-wrapper { flex: 1; }

    .submit-btn {
      padding: 1rem 2rem;
      background: #A3F3C5;
      color: #101314;
      border: none;
      border-radius: 0.75rem;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .submit-btn:hover:not(:disabled) { background: #8de0ad; transform: scale(1.05); }
    .submit-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #6b7280; }

    .action-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1.5rem; }
    .action-btn {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #EDEFED;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .action-btn:hover {
      border-color: #FF9F40;
      background: rgba(255, 159, 64, 0.1);
      transform: translateY(-2px);
    }
    .action-btn-icon { display: block; font-size: 1.5rem; margin-bottom: 0.25rem; }

    .hidden { display: none !important; }

    .orb {
      position: absolute;
      background: #A3F3C5;
      opacity: 0.1;
      border-radius: 50%;
      filter: blur(60px);
    }
    .orb-1 { top: 5rem; left: 2.5rem; width: 18rem; height: 18rem; animation: float 6s ease-in-out infinite; }
    .orb-2 { bottom: 5rem; right: 2.5rem; width: 24rem; height: 24rem; animation: float 6s ease-in-out infinite; animation-delay: -3s; }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 2rem; }
    .stat-card { background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; padding: 1rem; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #A3F3C5; }
    .stat-label { font-size: 0.75rem; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; }

    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
    .info-box {
      background: rgba(255, 159, 64, 0.1);
      border: 1px solid #FF9F40;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .info-box-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .info-box-text { color: #FFB366; font-weight: 600; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const SHEETS_URL = https://script.google.com/macros/s/AKfycbwPKWXx29r4WlX74bgbm5IFtBWg0Oxh5kFTWaSojwK0yXKhCn7b8dEQYR8Y5lsie_o/exec

    let state = {
      stage: 'name',
      employeeName: '',
      verificationMode: null,
      locationData: null,
      currentIndex: 0,

      calcValue: '',
      calcOperator: null,
      calcPrevValue: null,
      showCalculator: false,

      awaitingCount: false,
      locationVerified: false,

      lastUPCInputTime: 0,
      upcAutoTimer: null,

      queuedLocations: [],
      loadingQueue: false,

      validUPCs: [],

      // temp values for logging
      tempUPCResult: null,
      tempScannedUPC: '',
      tempUPCInMasterList: true,

      // open verification state
      openScannedLocation: '',
      openScannedUPC: '',
      openTotalScans: 0
    };

    let audioContext;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep(frequency = 800, duration = 100) {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    function playSuccessBeep() {
      playBeep(800, 100);
      setTimeout(() => playBeep(1000, 100), 100);
    }

    function playErrorBeep() {
      playBeep(400, 200);
    }

    function setName() {
      const name = document.getElementById('employeeName').value.trim();
      if (!name) {
        showAlert('‚ö†Ô∏è Please enter your name', 'error');
        return;
      }
      state.employeeName = name;
      state.stage = 'choice';
      render();
    }

    function selectMode(mode) {
      state.verificationMode = mode;

      if (mode === 'count') {
        state.stage = 'count-choice';
        loadQueueFromSheets();
      } else if (mode === 'open') {
        state.stage = 'open-verify';
        render();
      } else {
        state.stage = 'upload';
      }
      render();
    }

    async function loadQueueFromSheets() {
      state.loadingQueue = true;
      try {
        const response = await fetch(`${SHEETS_URL}?action=get_queue`);
        const data = await response.json();

        if (data.result === 'success' && data.queue) {
          state.queuedLocations = data.queue;
          console.log('Loaded queue:', state.queuedLocations);
        }
      } catch (error) {
        console.error('Failed to load queue:', error);
      }
      state.loadingQueue = false;
      render();
    }

    function useQueue() {
      if (state.queuedLocations.length === 0) {
        showAlert('‚ö†Ô∏è Queue is empty. Please upload a file instead.', 'warning');
        return;
      }

      state.locationData = state.queuedLocations.map(item => ({
        location: item.location,
        upc: item.expected_upc,
        unitCount: 0
      }));

      state.stage = 'verify';
      showAlert(`‚úÖ Loaded ${state.locationData.length} locations from queue`, 'success');
      render();
    }

    function useFile() {
      state.stage = 'upload';
      render();
    }

    function parseExcelFile(file) {
      const reader = new FileReader();

      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellText: false, cellDates: false });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });

          console.log('Parsed data sample:', jsonData.slice(0, 3));
          validateLocationData(jsonData);
        } catch (error) {
          showAlert(`Error reading file: ${error.message}`, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function validateLocationData(data) {
      if (data.length === 0) {
        showAlert('File is empty', 'error');
        return;
      }

      const firstRow = data[0];
      const headers = Object.keys(firstRow);

      let locationCol = headers.find(h =>
        h.toLowerCase() === 'location' ||
        h.toLowerCase() === 'loc'
      );

      let upcCol = headers.find(h => h.toLowerCase() === 'upc');

      if (!upcCol) {
        upcCol = headers.find(h => h.toLowerCase() === 'sku');
        console.warn('UPC column not found, falling back to SKU column');
      }

      let countCol = headers.find(h =>
        h.toLowerCase() === 'location on hand' ||
        h.toLowerCase() === 'locationonhand' ||
        h.toLowerCase() === 'count' ||
        h.toLowerCase() === 'qty' ||
        h.toLowerCase() === 'quantity' ||
        h.toLowerCase() === 'unit count' ||
        h.toLowerCase() === 'unitcount'
      );

      if (!locationCol) {
        showAlert('‚ùå Could not find "Location" column in file', 'error');
        return;
      }

      if (!upcCol) {
        showAlert('‚ùå Could not find "UPC" or "SKU" column in file', 'error');
        return;
      }

      console.log(`Found columns - Location: "${locationCol}", UPC: "${upcCol}", Count: "${countCol}"`);

      const normalized = data.map((row) => {
        let location = String(row[locationCol] || '').trim();

        let upcRaw = row[upcCol];
        let upc = '';

        if (upcRaw === null || upcRaw === undefined || upcRaw === '') {
          upc = '';
        } else {
          upc = String(upcRaw).trim();
          upc = upc.replace(/^'+/, '');
        }

        let unitCount = countCol ? parseInt(row[countCol] || 0) : 0;

        return { location, upc, unitCount };
      }).filter(row => row.location && row.upc);

      if (normalized.length === 0) {
        showAlert('No valid location and UPC data found', 'error');
        return;
      }

      state.validUPCs = [...new Set(normalized.map(row => row.upc))];
      state.locationData = normalized;
      state.stage = 'verify';
      showAlert(`‚úÖ File loaded: ${normalized.length} locations`, 'success');
      render();
    }

    async function logToSheets(eventData) {
      const payload = {
        timestamp: new Date().toISOString(),
        employee_name: state.employeeName,
        verification_mode: state.verificationMode,
        ...eventData
      };

      try {
        await fetch(SHEETS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        console.log('Logged to sheets:', payload);
      } catch (error) {
        console.error('Failed to log to sheets:', error);
      }
    }

    function handleOpenLocationInput(event) {
      const scanned = event.target.value.trim().toUpperCase();

      if (scanned.length >= 3 && event.key === 'Enter') {
        state.openScannedLocation = scanned;
        playSuccessBeep();
        showAlert('‚úÖ Location captured', 'success');
        
        event.target.style.display = 'none';
        
        setTimeout(() => {
          const upcInput = document.getElementById('openUpcScan');
          if (upcInput) upcInput.focus();
        }, 50);
        
        updateOpenVerifyScreen();
      }
    }

    function handleOpenUPCInput(event) {
      const upcInput = event.target;

      state.lastUPCInputTime = Date.now();

      if (state.upcAutoTimer) clearTimeout(state.upcAutoTimer);

      state.upcAutoTimer = setTimeout(() => {
        if (Date.now() - state.lastUPCInputTime >= 300) {
          if (upcInput.value.trim().length > 0) {
            submitOpenUPC();
          }
        }
      }, 300);
    }

    function submitOpenUPC() {
      const upcInput = document.getElementById('openUpcScan');
      if (!upcInput) return;

      const scanned = upcInput.value.trim().replace(/^'+/, '').toUpperCase();

      if (!scanned) return;

      state.openScannedUPC = scanned;
      playSuccessBeep();
      showAlert('‚úÖ UPC recorded', 'success');

      logOpenResult(state.openScannedLocation, scanned);
      
      state.openTotalScans++;
      state.openScannedLocation = '';
      state.openScannedUPC = '';
      
      upcInput.value = '';
      
      setTimeout(() => {
        const locationInput = document.getElementById('openLocationScan');
        if (locationInput) {
          locationInput.style.display = 'block';
          locationInput.value = '';
          locationInput.focus();
        }
        updateOpenVerifyScreen();
      }, 500);
    }

    function handleOpenNoUPC() {
      playSuccessBeep();
      logOpenResult(state.openScannedLocation, 'NO_UPC');
      
      state.openTotalScans++;
      state.openScannedLocation = '';
      state.openScannedUPC = '';
      
      setTimeout(() => {
        const locationInput = document.getElementById('openLocationScan');
        if (locationInput) {
          locationInput.style.display = 'block';
          locationInput.value = '';
          locationInput.focus();
        }
        updateOpenVerifyScreen();
      }, 500);
    }

    function handleOpenNoItem() {
      playSuccessBeep();
      logOpenResult(state.openScannedLocation, 'NO_ITEM');
      
      state.openTotalScans++;
      state.openScannedLocation = '';
      state.openScannedUPC = '';
      
      setTimeout(() => {
        const locationInput = document.getElementById('openLocationScan');
        if (locationInput) {
          locationInput.style.display = 'block';
          locationInput.value = '';
          locationInput.focus();
        }
        updateOpenVerifyScreen();
      }, 500);
    }

    function handleOpenMixedLocation() {
      playSuccessBeep();
      logOpenResult(state.openScannedLocation, 'MIXED_LOCATION');
      
      state.openTotalScans++;
      state.openScannedLocation = '';
      state.openScannedUPC = '';
      
      setTimeout(() => {
        const locationInput = document.getElementById('openLocationScan');
        if (locationInput) {
          locationInput.style.display = 'block';
          locationInput.value = '';
          locationInput.focus();
        }
        updateOpenVerifyScreen();
      }, 500);
    }

    function logOpenResult(location, scannedUPC) {
      let upcStatus = 'Scanned';
      if (scannedUPC === 'NO_UPC') upcStatus = 'No UPC';
      else if (scannedUPC === 'NO_ITEM') upcStatus = 'No Item';
      else if (scannedUPC === 'MIXED_LOCATION') upcStatus = 'Mixed Location';

      logToSheets({
        location: location,
        expected_upc: '',
        scanned_upc: scannedUPC,
        upc_status: upcStatus,
        expected_count: null,
        actual_count: null,
        step: state.openTotalScans + 1,
        total_steps: null,
        in_master_list: true,
        sheet_name: 'master_open'
      });
    }

    function updateOpenVerifyScreen() {
      if (state.stage !== 'open-verify') return;

      const stats = document.querySelectorAll('.stat-value');
      if (stats[0]) stats[0].textContent = state.openTotalScans;

      const locationSection = document.getElementById('openLocationSection');
      if (locationSection) locationSection.style.display = state.openScannedLocation ? 'none' : 'block';

      const upcSection = document.getElementById('openUpcSection');
      if (upcSection) upcSection.style.display = state.openScannedLocation ? 'block' : 'none';

      const actionButtons = document.getElementById('openActionButtons');
      if (actionButtons) actionButtons.style.display = state.openScannedLocation ? 'block' : 'none';
    }

    function handleLocationInput(event) {
      const scanned = event.target.value.trim().toUpperCase();
      const current = state.locationData[state.currentIndex];

      if (scanned.length >= current.location.length) {
        if (scanned === current.location.toUpperCase()) {
          playSuccessBeep();
          showAlert('‚úÖ Location verified', 'success');

          state.locationVerified = true;

          // Hide location input immediately
          event.target.style.display = 'none';

          setTimeout(() => {
            const upcInput = document.getElementById('upcScan');
            if (upcInput) upcInput.focus();
          }, 50);

          updateVerifyScreen();
        } else {
          playErrorBeep();
          showAlert(`‚ùå Wrong location! Expected: ${current.location}`, 'error');
          event.target.value = '';
        }
      }
    }

    // ‚úÖ Auto-submit after 300ms idle (allows full barcode scan to complete)
    function handleUPCInput(event) {
      const upcInput = event.target;

      state.lastUPCInputTime = Date.now();

      if (state.upcAutoTimer) clearTimeout(state.upcAutoTimer);

      state.upcAutoTimer = setTimeout(() => {
        if (Date.now() - state.lastUPCInputTime >= 300) {
          if (upcInput.value.trim().length > 0) {
            submitUPC(true);
          }
        }
      }, 300);
    }

    // ‚úÖ No master list, no retries, no blocking
    function submitUPC(fromAuto = false) {
      const upcInput = document.getElementById('upcScan');
      const current = state.locationData[state.currentIndex];

      if (!upcInput || !current) return;

      const scanned = upcInput.value.trim().replace(/^'+/, '').toUpperCase();
      const expected = String(current.upc).trim().replace(/^'+/, '').toUpperCase();

      if (!scanned) {
        if (fromAuto) return;
        showAlert('‚ö†Ô∏è Please enter UPC', 'error');
        return;
      }

      const isCorrect = (scanned === expected);

      state.tempUPCResult = isCorrect;
      state.tempScannedUPC = scanned;
      state.tempUPCInMasterList = true;

      if (isCorrect) {
        playSuccessBeep();
        showAlert('‚úÖ UPC recorded', 'success');
      } else {
        playErrorBeep();
        showAlert('‚ö†Ô∏è UPC recorded (does not match expected)', 'warning');
      }

      // clear input for next scan
      upcInput.value = '';

      if (state.verificationMode === 'count') {
        state.awaitingCount = true;
        state.locationVerified = false;

        updateVerifyScreen();

        setTimeout(() => {
          const countInput = document.getElementById('countInput');
          if (countInput) countInput.focus();
        }, 100);
      } else {
        logResult(isCorrect, scanned, null, null);
        moveToNext();
      }
    }

    function handleNoUPC() {
      playSuccessBeep();

      state.tempUPCResult = false;
      state.tempScannedUPC = 'NO_UPC';
      state.tempUPCInMasterList = true;

      if (state.verificationMode === 'count') {
        state.awaitingCount = true;
        state.locationVerified = false;
        showAlert('‚úì No UPC recorded. Enter count below.', 'success');
        updateVerifyScreen();
        setTimeout(() => {
          const countInput = document.getElementById('countInput');
          if (countInput) countInput.focus();
        }, 100);
      } else {
        logResult(false, 'NO_UPC', null, null);
        moveToNext();
      }
    }

    function handleNoItem() {
      playSuccessBeep();

      if (state.verificationMode === 'count') {
        logResult(false, 'NO_ITEM', 0, 0);
      } else {
        logResult(false, 'NO_ITEM', null, null);
      }
      moveToNext();
    }

    function handleMixedLocation() {
      playSuccessBeep();

      if (state.verificationMode === 'count') {
        logResult(false, 'MIXED_LOCATION', null, null);
      } else {
        logResult(false, 'MIXED_LOCATION', null, null);
      }
      moveToNext();
    }

    function submitCount() {
      const countInput = document.getElementById('countInput');
      const count = parseInt(countInput.value);
      const current = state.locationData[state.currentIndex];

      if (isNaN(count) || count < 0) {
        showAlert('‚ö†Ô∏è Please enter a valid count', 'error');
        return;
      }

      logResult(state.tempUPCResult, state.tempScannedUPC, current.unitCount, count);
      state.awaitingCount = false;
      moveToNext();
    }

    function logResult(isCorrect, scannedUPC, expectedCount, actualCount) {
      const current = state.locationData[state.currentIndex];

      let upcStatus = 'Correct';
      if (scannedUPC === 'NO_UPC') upcStatus = 'No UPC';
      else if (scannedUPC === 'NO_ITEM') upcStatus = 'No Item';
      else if (scannedUPC === 'MIXED_LOCATION') upcStatus = 'Mixed Location';
      else if (!isCorrect) upcStatus = 'Incorrect';

      logToSheets({
        location: current.location,
        expected_upc: current.upc,
        scanned_upc: scannedUPC,
        upc_status: upcStatus,
        expected_count: expectedCount,
        actual_count: actualCount,
        step: state.currentIndex + 1,
        total_steps: state.locationData.length,
        in_master_list: true
      });
    }

    function moveToNext() {
      showAlert('‚úì Recorded, moving to next...', 'success');

      setTimeout(() => {
        if (state.currentIndex < state.locationData.length - 1) {
          state.currentIndex++;
          state.calcValue = '';
          state.calcOperator = null;
          state.calcPrevValue = null;
          state.locationVerified = false;
          state.lastUPCInputTime = 0;
          if (state.upcAutoTimer) {
            clearTimeout(state.upcAutoTimer);
            state.upcAutoTimer = null;
          }
          render();
        } else {
          state.stage = 'complete';
          render();
        }
      }, 1000);
    }

    function calcPress(val) {
      if (val === 'C') {
        state.calcValue = '';
        state.calcOperator = null;
        state.calcPrevValue = null;
      } else if (['+', '-', '√ó', '√∑'].includes(val)) {
        if (state.calcValue) {
          state.calcPrevValue = parseFloat(state.calcValue);
          state.calcOperator = val;
          state.calcValue = '';
        }
      } else if (val === '=') {
        if (state.calcOperator && state.calcPrevValue !== null && state.calcValue) {
          const prev = state.calcPrevValue;
          const current = parseFloat(state.calcValue);
          let result = 0;

          switch (state.calcOperator) {
            case '+': result = prev + current; break;
            case '-': result = prev - current; break;
            case '√ó': result = prev * current; break;
            case '√∑': result = prev / current; break;
          }

          state.calcValue = Math.round(result).toString();
          state.calcOperator = null;
          state.calcPrevValue = null;

          const countInput = document.getElementById('countInput');
          if (countInput) countInput.value = state.calcValue;
        }
      } else {
        state.calcValue += val;
      }

      updateVerifyScreen();
    }

    function toggleCalculator() {
      state.showCalculator = !state.showCalculator;
      updateVerifyScreen();
    }

    function closeCalculator() {
      state.showCalculator = false;
      updateVerifyScreen();
    }

    function showAlert(message, type) {
      const alertDiv = document.getElementById('alertBox');
      if (!alertDiv) return;

      alertDiv.innerHTML = `<div class="alert alert-${type} fade-in-up">${message}</div>`;
      setTimeout(() => { alertDiv.innerHTML = ''; }, 4000);
    }

    function goHome() {
      if (confirm('Return home? Progress will be lost.')) {
        window.location.reload();
      }
    }

    function updateVerifyScreen() {
      if (state.stage !== 'verify') return;

      const scanned = state.currentIndex;
      const remaining = state.locationData.length - state.currentIndex;

      const stats = document.querySelectorAll('.stat-value');
      if (stats[0]) stats[0].textContent = scanned;
      if (stats[1]) stats[1].textContent = remaining;

      const upcSection = document.getElementById('upcSection');
      if (upcSection) upcSection.style.display = state.locationVerified ? 'block' : 'none';

      const actionButtons = document.getElementById('actionButtons');
      if (actionButtons) actionButtons.style.display = state.locationVerified ? 'block' : 'none';

      const countSection = document.getElementById('countSection');
      if (countSection) countSection.style.display = state.awaitingCount ? 'block' : 'none';

      const calcModal = document.getElementById('calcModal');
      if (calcModal) calcModal.style.display = state.showCalculator ? 'flex' : 'none';

      const calcDisplay = document.querySelector('.calc-display');
      if (calcDisplay) {
        let displayText = state.calcValue || '0';
        if (state.calcOperator && state.calcPrevValue !== null) {
          displayText = `${state.calcPrevValue} ${state.calcOperator} ${state.calcValue || ''}`;
        }
        calcDisplay.textContent = displayText;
      }

      const calcIcon = document.getElementById('calcIcon');
      if (calcIcon) calcIcon.style.display = state.awaitingCount ? 'flex' : 'none';
    }

    function render() {
      const app = document.getElementById('app');
      let content = '';

      if (state.stage === 'name') {
        content = `
          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 48rem;">
                <h1 class="title">Location<br/>Verification</h1>
                <p class="subtitle">Ensure inventory accuracy</p>

                <div id="alertBox"></div>

                <div style="margin-bottom: 2rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">Employee Name / ID</label>
                  <input type="text" id="employeeName" class="input" placeholder="Enter your name or ID" autofocus>
                </div>

                <button onclick="setName()" class="btn btn-primary glow">
                  Continue ‚Üí
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'choice') {
        content = `
          <button onclick="state.stage = 'name'; render();" class="home-btn">
            ‚Üê Back
          </button>

          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 56rem;">
                <h1 class="title">Choose Mode</h1>
                <p class="subtitle">Select verification type</p>

                <div id="alertBox"></div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                  <div class="choice-card" onclick="selectMode('verification')">
                    <div class="choice-icon">üîç</div>
                    <div class="choice-title">Location Verification</div>
                    <div class="choice-desc">Verify location and UPC only</div>
                  </div>

                  <div class="choice-card" onclick="selectMode('count')">
                    <div class="choice-icon">üìä</div>
                    <div class="choice-title">Location Count</div>
                    <div class="choice-desc">Verify location, UPC, and unit count</div>
                  </div>

                  <div class="choice-card" onclick="selectMode('open')">
                    <div class="choice-icon">üåê</div>
                    <div class="choice-title">Open Verification</div>
                    <div class="choice-desc">Scan any location freely</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'count-choice') {
        const queueCount = state.queuedLocations.length;
        const loadingText = state.loadingQueue ? 'Loading...' : `${queueCount} items`;

        content = `
          <button onclick="state.stage = 'choice'; render();" class="home-btn">
            ‚Üê Back
          </button>

          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 56rem;">
                <h1 class="title">Count Mode</h1>
                <p class="subtitle">Choose your data source</p>

                <div id="alertBox"></div>

                <div class="grid-2">
                  <div class="choice-card" onclick="useQueue()">
                    <div class="choice-icon">‚è≥</div>
                    <div class="choice-title">Use Queue</div>
                    <div class="choice-desc">Count locations from verification errors</div>
                    <div class="queue-badge">${loadingText}</div>
                  </div>

                  <div class="choice-card" onclick="useFile()">
                    <div class="choice-icon">üìÅ</div>
                    <div class="choice-title">Upload File</div>
                    <div class="choice-desc">Count locations from Excel/CSV file</div>
                  </div>
                </div>

                ${queueCount > 0 ? `
                <div class="info-box">
                  <div class="info-box-icon">‚ÑπÔ∏è</div>
                  <div class="info-box-text">
                    Queue contains ${queueCount} location${queueCount !== 1 ? 's' : ''} flagged during verification
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'upload') {
        content = `
          <button onclick="state.stage = '${state.verificationMode === 'count' ? 'count-choice' : 'choice'}'; render();" class="home-btn">
            ‚Üê Back
          </button>

          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 48rem;">
                <h1 class="title">Upload File</h1>
                <p class="subtitle">${state.verificationMode === 'count' ? 'Location Count Mode' : 'Location Verification Mode'}</p>

                <div id="alertBox"></div>

                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 600; color: #EDEFED; margin-bottom: 0.5rem;">
                    üë§ ${state.employeeName}
                  </div>
                  <div style="font-size: 1rem; color: #A3F3C5;">
                    ${state.verificationMode === 'count' ? 'üìä Count Mode' : 'üîç Verification Mode'}
                  </div>
                </div>

                <div style="margin-bottom: 2rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">Upload Your Location File</label>
                  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                  <button onclick="document.getElementById('fileInput').click()" class="btn btn-secondary">
                    üìÅ Choose File
                  </button>
                  <p style="text-align: center; color: #9D9F9E; font-size: 0.875rem; margin-top: 0.75rem;">Excel or CSV with Location (A), Location On Hand (B), and UPC (E) columns</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'verify') {
        const current = state.locationData[state.currentIndex];
        const progress = ((state.currentIndex / state.locationData.length) * 100).toFixed(0);
        const scanned = state.currentIndex;
        const remaining = state.locationData.length - state.currentIndex;

        let displayText = state.calcValue || '0';
        if (state.calcOperator && state.calcPrevValue !== null) {
          displayText = `${state.calcPrevValue} ${state.calcOperator} ${state.calcValue || ''}`;
        }

        content = `
          <button onclick="goHome()" class="home-btn pulse">
            üè† Home
          </button>

          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 64rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                  <div style="color: #A3F3C5; font-weight: 600; font-size: 1.125rem;">
                    ${state.employeeName}
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    ${state.verificationMode === 'count'
                      ? '<span style="background: #A3F3C5; color: #101314; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.875rem;">üìä COUNT MODE</span>'
                      : '<span style="background: rgba(255, 255, 255, 0.1); color: #A3F3C5; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.875rem;">üîç VERIFY MODE</span>'}
                  </div>
                </div>

                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                  Location ${state.currentIndex + 1} of ${state.locationData.length}
                </div>

                <div class="location-card glow">
                  <div class="location-label">üìç Go to Location</div>
                  <div class="location-value">${current.location}</div>
                </div>

                <div id="alertBox"></div>

                <div id="locationSection" style="display: ${state.locationVerified ? 'none' : 'block'}; margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üîç Scan Location
                  </label>
                  <input type="text" id="locationScan" class="input input-scan" placeholder="SCAN LOCATION" autofocus>
                </div>

                <div id="upcSection" style="display: ${state.locationVerified ? 'block' : 'none'}; margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üì¶ Scan UPC
                  </label>
                  <div class="scan-input-section">
                    <div class="scan-input-wrapper">
                      <input type="text" id="upcScan" class="input input-scan" placeholder="SCAN UPC" autofocus>
                    </div>
                    <!-- ‚úÖ Auto-submits after 300ms idle -->
                  </div>
                </div>

                <div id="actionButtons" style="display: ${state.locationVerified ? 'block' : 'none'};">
                  <div class="action-buttons">
                    <button class="action-btn" onclick="handleNoUPC()">
                      <span class="action-btn-icon">üö´</span>
                      No UPC
                    </button>
                    <button class="action-btn" onclick="handleNoItem()">
                      <span class="action-btn-icon">üì≠</span>
                      Nothing Here
                    </button>
                    <button class="action-btn" onclick="handleMixedLocation()">
                      <span class="action-btn-icon">üîÄ</span>
                      Mixed Location
                    </button>
                  </div>
                </div>

                <div id="countSection" style="display: ${state.awaitingCount ? 'block' : 'none'}; margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üìä Enter Unit Count
                  </label>
                  <div class="count-input-section">
                    <div class="count-input-wrapper">
                      <input type="number" id="countInput" class="input input-scan" placeholder="0" min="0" value="${state.calcValue}">
                    </div>
                    <button onclick="submitCount()" class="submit-btn glow">
                      ‚úì Submit
                    </button>
                  </div>
                </div>

                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">${scanned}</div>
                    <div class="stat-label">Scanned</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${remaining}</div>
                    <div class="stat-label">Remaining</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="calcIcon" class="calc-icon pulse" style="display: ${state.awaitingCount ? 'flex' : 'none'};" onclick="toggleCalculator()">
            üî¢
          </div>

          <div id="calcModal" class="calc-modal" style="display: ${state.showCalculator ? 'flex' : 'none'};" onclick="if(event.target === this) closeCalculator()">
            <div class="calc-container slide-up">
              <div style="text-align: center; font-size: 1.25rem; font-weight: 600; color: #A3F3C5; margin-bottom: 1rem;">
                Calculator
              </div>
              <div class="calc-display">${displayText}</div>
              <div class="calc-grid">
                <button class="calc-btn" onclick="calcPress('7')">7</button>
                <button class="calc-btn" onclick="calcPress('8')">8</button>
                <button class="calc-btn" onclick="calcPress('9')">9</button>
                <button class="calc-btn" onclick="calcPress('√∑')">√∑</button>

                <button class="calc-btn" onclick="calcPress('4')">4</button>
                <button class="calc-btn" onclick="calcPress('5')">5</button>
                <button class="calc-btn" onclick="calcPress('6')">6</button>
                <button class="calc-btn" onclick="calcPress('√ó')">√ó</button>

                <button class="calc-btn" onclick="calcPress('1')">1</button>
                <button class="calc-btn" onclick="calcPress('2')">2</button>
                <button class="calc-btn" onclick="calcPress('3')">3</button>
                <button class="calc-btn" onclick="calcPress('-')">-</button>

                <button class="calc-btn calc-btn-clear" onclick="calcPress('C')">C</button>
                <button class="calc-btn" onclick="calcPress('0')">0</button>
                <button class="calc-btn calc-btn-equals" onclick="calcPress('=')">=</button>
                <button class="calc-btn" onclick="calcPress('+')">+</button>

                <button class="calc-btn calc-btn-close" onclick="closeCalculator()">Close</button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'open-verify') {
        content = `
          <button onclick="goHome()" class="home-btn pulse">
            üè† Home
          </button>

          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>

            <div class="container">
              <div class="card scale-in" style="max-width: 64rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                  <div style="color: #A3F3C5; font-weight: 600; font-size: 1.125rem;">
                    ${state.employeeName}
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="background: rgba(255, 255, 255, 0.1); color: #A3F3C5; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.875rem;">üåê OPEN MODE</span>
                  </div>
                </div>

                <div class="location-card glow">
                  <div class="location-label">üåê Open Verification</div>
                  <div style="font-size: 2rem; color: white; font-weight: 600; margin-bottom: 1rem;">
                    Scan any location
                  </div>
                </div>

                <div id="alertBox"></div>

                <div id="openLocationSection" style="display: ${state.openScannedLocation ? 'none' : 'block'}; margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üîç Scan Location
                  </label>
                  <input type="text" id="openLocationScan" class="input input-scan" placeholder="SCAN LOCATION" autofocus>
                </div>

                <div id="openUpcSection" style="display: ${state.openScannedLocation ? 'block' : 'none'}; margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üì¶ Scan UPC
                  </label>
                  <div class="scan-input-section">
                    <div class="scan-input-wrapper">
                      <input type="text" id="openUpcScan" class="input input-scan" placeholder="SCAN UPC">
                    </div>
                  </div>
                </div>

                <div id="openActionButtons" style="display: ${state.openScannedLocation ? 'block' : 'none'};">
                  <div class="action-buttons">
                    <button class="action-btn" onclick="handleOpenNoUPC()">
                      <span class="action-btn-icon">üö´</span>
                      No UPC
                    </button>
                    <button class="action-btn" onclick="handleOpenNoItem()">
                      <span class="action-btn-icon">üì≠</span>
                      Nothing Here
                    </button>
                    <button class="action-btn" onclick="handleOpenMixedLocation()">
                      <span class="action-btn-icon">üîÄ</span>
                      Mixed Location
                    </button>
                  </div>
                </div>

                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">${state.openTotalScans}</div>
                    <div class="stat-label">Total Scanned</div>
                  </div>
                  <div class="stat-card" style="background: rgba(163, 243, 197, 0.1);">
                    <div class="stat-value" style="color: #A3F3C5;">‚àû</div>
                    <div class="stat-label">Free Mode</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'complete') {
        const totalScanned = state.locationData.length;

        content = `
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in" style="text-align: center; padding: 4rem;">
              <div style="font-size: 6rem; margin-bottom: 2rem;" class="pulse">üéâ</div>
              <h2 style="font-size: 4rem; font-weight: 300; margin-bottom: 1.5rem; background: linear-gradient(to right, white, #A3F3C5); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                ${state.verificationMode === 'count' ? 'Count' : 'Verification'} Complete!
              </h2>
              <p style="color: #9D9F9E; font-size: 1.5rem; margin-bottom: 3rem; font-weight: 300;">
                Excellent work, ${state.employeeName}!
              </p>

              <div style="max-width: 24rem; margin: 0 auto 3rem;">
                <div class="stat-card" style="padding: 2rem;">
                  <div class="stat-value" style="font-size: 4rem;">${totalScanned}</div>
                  <div class="stat-label" style="font-size: 1rem;">Locations ${state.verificationMode === 'count' ? 'Counted' : 'Verified'}</div>
                </div>
              </div>

              <button onclick="goHome()" class="btn btn-primary glow" style="max-width: 24rem; margin: 0 auto;">
                Back to Home
              </button>
            </div>
          </div>
        `;
      }

      app.innerHTML = content;

      setTimeout(() => {
        if (state.stage === 'name') {
          const nameInput = document.getElementById('employeeName');
          if (nameInput) {
            nameInput.focus();
            nameInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') setName();
            });
          }
        }

        if (state.stage === 'upload') {
          const fileInput = document.getElementById('fileInput');
          if (fileInput) {
            fileInput.addEventListener('change', (e) => {
              const file = e.target.files[0];
              if (file) parseExcelFile(file);
            });
          }
        }

        if (state.stage === 'verify') {
          const locationInput = document.getElementById('locationScan');
          const upcInput = document.getElementById('upcScan');

          if (locationInput) {
            locationInput.focus();
            locationInput.addEventListener('input', handleLocationInput);
          }

          if (upcInput) {
            upcInput.addEventListener('input', handleUPCInput);

            // optional: Enter still works (manual submit)
            upcInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                submitUPC(false);
              }
            });
          }
        }

        if (state.stage === 'open-verify') {
          const openLocationInput = document.getElementById('openLocationScan');
          const openUpcInput = document.getElementById('openUpcScan');

          if (openLocationInput) {
            openLocationInput.focus();
            openLocationInput.addEventListener('keypress', handleOpenLocationInput);
          }

          if (openUpcInput) {
            openUpcInput.addEventListener('input', handleOpenUPCInput);
          }
        }
      }, 100);
    }

    render();
  </script>
</body>
</html>


