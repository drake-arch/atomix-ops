<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan Flow</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#070a12;
      --bg1:#0b1123;
      --card:#0f1835;
      --card2:#0c1430;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;
      --amber:#f59e0b;
      --shadow: 0 14px 45px rgba(0,0,0,.55);
      --r:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(1000px 700px at 50% 110%, rgba(245,158,11,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      background: rgba(15,24,53,.75);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 14px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{ display:flex; flex-direction:column; gap:3px; }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing: .3px;
      opacity:.9;
      font-weight: 800;
    }
    .brand .sub{ font-size: 12px; color: var(--muted); }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.25); }
    .dot.green{ background: rgba(34,197,94,.9); }
    .dot.blue{ background: rgba(59,130,246,.95); }
    .dot.red{ background: rgba(239,68,68,.95); }
    .dot.amber{ background: rgba(245,158,11,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(15,24,53,.78);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .setupRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ flex:1; min-width: 220px; }
    .field label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      margin: 0 0 6px 2px;
    }
    input, select, button{
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::file-selector-button{
      border:0; padding: 8px 10px; border-radius: 12px;
      background: rgba(59,130,246,.22);
      color: var(--text);
      cursor:pointer;
      margin-right: 10px;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ width:auto; padding: 12px 14px; font-weight: 800; letter-spacing: .2px; cursor:pointer; }
    .btn.primary{ background: rgba(59,130,246,.95); border-color: rgba(59,130,246,.95); }
    .btn.secondary{ background: rgba(255,255,255,.06); }
    .btn.danger{ background: rgba(239,68,68,.95); border-color: rgba(239,68,68,.95); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .divider{ height:1px; background: var(--line); margin: 12px 0; }

    /* Step Card */
    .stepCard{
      padding: 16px;
      border-radius: calc(var(--r) + 6px);
      background:
        radial-gradient(700px 400px at 10% 10%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(700px 400px at 90% 30%, rgba(34,197,94,.20), transparent 55%),
        rgba(12,20,48,.78);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .stepTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .stepLabel{
      font-size: 12px; color: var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .stepTitle{
      margin: 8px 0 2px;
      font-size: 38px;
      font-weight: 950;
      letter-spacing: .4px;
      line-height: 1.05;
    }
    .expectedBox{
      margin-top: 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .expectedBox .k{ font-size: 11px; color: var(--muted); }
    .expectedBox .v{
      font-size: 18px; font-weight: 900;
      letter-spacing: .3px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .statusLine{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      padding: 2px 8px;
      border-radius: 999px;
      color: var(--text);
    }

    /* Right panel progress */
    .bigNum{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: .4px;
    }
    .bar{
      width:100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(34,197,94,.95));
      border-radius: 999px;
      transition: width .18s ease;
    }
    .miniStats{
      margin-top: 10px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .mini{
      flex:1;
      min-width: 110px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
    }
    .mini .k{ font-size: 11px; color: var(--muted); }
    .mini .v{ font-size: 20px; font-weight: 950; margin-top: 3px; }

    /* Modal */
    .modalBackdrop{ position:fixed; inset:0; background: rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; padding: 18px; }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(430px, 100%);
      border-radius: 22px;
      background: rgba(15,24,53,.92);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(14px);
    }
    .countDisplay{
      margin-top:10px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding: 14px;
      font-size: 44px;
      font-weight: 950;
      text-align:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .keypad{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top: 12px; }
    .key{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 22px;
      font-weight: 950;
      cursor:pointer;
    }
    .key.enter{ background: rgba(34,197,94,.95); border-color: rgba(34,197,94,.95); color:#06210f; }
    .key.wide{ grid-column: span 2; }

    /* Tiny toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border: 1px solid var(--line);
      color: var(--text);
      font-size: 13px;
      display:none;
      backdrop-filter: blur(10px);
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Scan Flow</h1>
        <div class="sub">Location → UPC → (Count) → Submit</div>
      </div>
      <div class="chips">
        <span class="chip" id="chipMode"><span class="dot blue"></span><span id="chipModeText">Verification</span></span>
        <span class="chip" id="chipStep"><span class="dot"></span><span id="chipStepText">Upload</span></span>
        <span class="chip"><span class="dot green"></span>Enter finishes scan</span>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Step -->
      <div class="panel">
        <div class="stepCard" id="stepCard">
          <div class="stepTop">
            <div class="stepLabel"><span class="dot" id="stepDot"></span><span id="stepSmall">Step</span></div>
            <div class="stepLabel"><span class="kbd" id="rowPill">0/0</span></div>
          </div>

          <div class="stepTitle" id="stepTitle">UPLOAD FILE</div>

          <div class="expectedBox">
            <div>
              <div class="k" id="expectedKey">Expected</div>
              <div class="v" id="expectedVal">—</div>
            </div>
            <div style="text-align:right;">
              <div class="k">Last Scan</div>
              <div class="v" id="lastScanVal">—</div>
            </div>
          </div>

          <div class="statusLine" id="statusLine">
            <span class="kbd" id="statusPill">Not started</span>
            <span class="muted" id="subHint">Upload a file, or load queue in Count mode.</span>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Setup (minimal) -->
        <div class="setupRow">
          <div class="field">
            <label>Name</label>
            <input id="employeeName" placeholder="Drake" />
          </div>

          <div class="field" style="max-width:260px;">
            <label>Mode</label>
            <select id="mode">
              <option value="verification">Verification</option>
              <option value="count">Count</option>
            </select>
          </div>

          <div class="field" id="countSourceWrap" style="display:none; max-width:270px;">
            <label>Count Source</label>
            <select id="countSource">
              <option value="queue">Queue</option>
              <option value="upload">Upload</option>
            </select>
          </div>
        </div>

        <div class="setupRow" style="margin-top:10px;">
          <div class="field">
            <label>Upload (.xlsx)</label>
            <input id="fileInput" type="file" accept=".xlsx,.xls" />
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn primary" id="startBtn" style="min-width:130px;">Start</button>
          <button class="btn secondary" id="submitBtn" style="min-width:130px;" disabled>Submit</button>
          <button class="btn secondary" id="loadQueueBtn" style="min-width:130px; display:none;">Load Queue</button>
          <button class="btn danger" id="resetBtn" style="min-width:130px;">Reset</button>
        </div>
      </div>

      <!-- Right: Progress -->
      <div class="panel">
        <div class="muted" style="font-size:12px;">Progress</div>
        <div class="bigNum"><span id="doneCount">0</span>/<span id="totalCount">0</span></div>
        <div class="bar"><div id="barFill"></div></div>

        <div class="miniStats">
          <div class="mini">
            <div class="k">Correct</div>
            <div class="v" id="correctCount">0</div>
          </div>
          <div class="mini">
            <div class="k">Incorrect</div>
            <div class="v" id="incorrectCount">0</div>
          </div>
          <div class="mini">
            <div class="k">Empty</div>
            <div class="v" id="emptyCount">0</div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted" style="font-size:12px;">
          Tip: Click the step card once if the scanner isn’t sending keystrokes to the page.
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="muted" style="text-align:center; font-size:12px;">Enter count</div>
      <div class="countDisplay" id="countDisplay">0</div>

      <div class="keypad">
        <button class="key" data-k="1">1</button>
        <button class="key" data-k="2">2</button>
        <button class="key" data-k="3">3</button>
        <button class="key" data-k="4">4</button>
        <button class="key" data-k="5">5</button>
        <button class="key" data-k="6">6</button>
        <button class="key" data-k="7">7</button>
        <button class="key" data-k="8">8</button>
        <button class="key" data-k="9">9</button>
        <button class="key" data-k="del">⌫</button>
        <button class="key" data-k="0">0</button>
        <button class="key enter" data-k="enter">Enter</button>
        <button class="key wide" data-k="clear">Clear</button>
        <button class="key wide" data-k="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

<script>
/** HARD-CODED APPS SCRIPT WEB APP URL **/
const API_URL = "https://script.google.com/macros/s/AKfycbylB5yoJrpLCf_AdPiYW2uJptcW-NADw0Zw_jw3Y7ENbxJLmoXTlnciQkeSCGqJo2MdkA/exec";

/** UI **/
const ui = {
  employeeName: document.getElementById('employeeName'),
  mode: document.getElementById('mode'),
  countSourceWrap: document.getElementById('countSourceWrap'),
  countSource: document.getElementById('countSource'),
  fileInput: document.getElementById('fileInput'),
  startBtn: document.getElementById('startBtn'),
  submitBtn: document.getElementById('submitBtn'),
  resetBtn: document.getElementById('resetBtn'),
  loadQueueBtn: document.getElementById('loadQueueBtn'),

  stepCard: document.getElementById('stepCard'),
  stepTitle: document.getElementById('stepTitle'),
  stepSmall: document.getElementById('stepSmall'),
  stepDot: document.getElementById('stepDot'),
  expectedKey: document.getElementById('expectedKey'),
  expectedVal: document.getElementById('expectedVal'),
  lastScanVal: document.getElementById('lastScanVal'),
  statusPill: document.getElementById('statusPill'),
  subHint: document.getElementById('subHint'),
  rowPill: document.getElementById('rowPill'),

  chipModeText: document.getElementById('chipModeText'),
  chipStepText: document.getElementById('chipStepText'),

  doneCount: document.getElementById('doneCount'),
  totalCount: document.getElementById('totalCount'),
  correctCount: document.getElementById('correctCount'),
  incorrectCount: document.getElementById('incorrectCount'),
  emptyCount: document.getElementById('emptyCount'),
  barFill: document.getElementById('barFill'),

  modalBackdrop: document.getElementById('modalBackdrop'),
  countDisplay: document.getElementById('countDisplay'),

  toast: document.getElementById('toast')
};

/** Data **/
let rows = []; // AoA
let currentIdx = 0;
let headerIdx = { loc:-1, upc:-1, expCount:-1 };

let step = 'upload'; // upload | location | upc | count | done

// Scan buffering (improved):
// - Enter/Tab ends scan (primary)
// - If scanner doesn't send Enter/Tab, we auto-finalize only if input was "scanner-fast"
let scanBuffer = '';
let lastKeyTime = 0;
let idleFinalizeTimer = null;
let bufferStartTime = 0;
let bufferCharCount = 0;

const SCAN_TIMEOUT_MS = 180;          // buffer resets if gap > this
const SCAN_IDLE_FINALIZE_MS = 180;    // backup finalize window
const SCAN_MAX_AVG_MS_PER_CHAR = 35;  // if avg time/char <= this, we treat it as a scan

const state = {
  started: false,
  mode: 'verification',
  employee: '',
  expectedLocation: '',
  expectedUPC: '',
  expectedCount: '',
  scannedUPC: '',
  scannedLocation: '',
  actualCount: null,
  rowScanStart: null,
  counts: { done:0, correct:0, incorrect:0, empty:0 }
};

function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add('show');
  setTimeout(() => ui.toast.classList.remove('show'), 1200);
}

function cleanLocationScan(s) {
  return String(s ?? '').trim().toUpperCase().replace(/\s+/g, ' ');
}

function normalizeLocation(s){ return cleanLocationScan(s); }
function normalizeUPC(s){ return String(s ?? '').replace(/\D/g,''); }

function beep(ok=true){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type='sine';
  o.frequency.value = ok ? 880 : 220;
  g.gain.value = 0.08;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  setTimeout(() => { o.stop(); ctx.close(); }, ok ? 90 : 140);
}

function totalSteps(){ return Math.max(0, rows.length - 1); }

function setChipStep(txt){ ui.chipStepText.textContent = txt; }
function setChipMode(){ ui.chipModeText.textContent = (state.mode === 'count') ? 'Count' : 'Verification'; }

function setStep(next){
  step = next;
  ui.submitBtn.disabled = true;

  ui.stepDot.className = 'dot ' + (
    step === 'location' ? 'blue' :
    step === 'upc' ? 'blue' :
    step === 'count' ? 'amber' :
    step === 'done' ? 'green' : ''
  );

  setChipMode();
  setChipStep(step.toUpperCase());

  if (step === 'upload'){
    ui.stepSmall.textContent = 'Setup';
    ui.stepTitle.textContent = 'UPLOAD FILE';
    ui.expectedKey.textContent = 'Expected';
    ui.expectedVal.textContent = '—';
    ui.lastScanVal.textContent = '—';
    ui.statusPill.textContent = 'Not started';
    ui.subHint.textContent = 'Upload a file (or load queue in Count mode).';
  }
  if (step === 'location'){
    ui.stepSmall.textContent = 'Step 1';
    ui.stepTitle.textContent = 'SCAN LOCATION';
    ui.expectedKey.textContent = 'Location';
    ui.expectedVal.textContent = state.expectedLocation || '—';
    ui.lastScanVal.textContent = '—';
    ui.statusPill.textContent = 'Waiting for scan';
    ui.subHint.textContent = 'Scan the location label.';
  }
  if (step === 'upc'){
    ui.stepSmall.textContent = 'Step 2';
    ui.stepTitle.textContent = 'SCAN UPC';
    ui.expectedKey.textContent = 'Expected UPC';
    ui.expectedVal.textContent = state.expectedUPC || '—';
    ui.lastScanVal.textContent = '—';
    ui.statusPill.textContent = 'Waiting for scan';
    ui.subHint.textContent = 'Scan the item UPC.';
  }
  if (step === 'count'){
    ui.stepSmall.textContent = 'Step 3';
    ui.stepTitle.textContent = 'ENTER COUNT';
    ui.expectedKey.textContent = 'Expected';
    ui.expectedVal.textContent = 'Hidden';
    ui.lastScanVal.textContent = String(state.actualCount ?? '—');
    ui.statusPill.textContent = 'Enter count';
    ui.subHint.textContent = 'Press Enter on the keypad to accept, then Submit.';
  }
  if (step === 'done'){
    ui.stepSmall.textContent = 'Complete';
    ui.stepTitle.textContent = 'DONE ✅';
    ui.expectedKey.textContent = 'Expected';
    ui.expectedVal.textContent = '—';
    ui.lastScanVal.textContent = '—';
    ui.statusPill.textContent = 'Finished';
    ui.subHint.textContent = 'All rows completed.';
  }
}

function updateProgress(){
  const total = totalSteps();
  ui.doneCount.textContent = state.counts.done;
  ui.totalCount.textContent = total;
  ui.correctCount.textContent = state.counts.correct;
  ui.incorrectCount.textContent = state.counts.incorrect;
  ui.emptyCount.textContent = state.counts.empty;

  const pct = total ? Math.min(100, Math.round((state.counts.done / total) * 100)) : 0;
  ui.barFill.style.width = pct + '%';

  ui.rowPill.textContent = total ? `${Math.min(total, currentIdx+1)}/${total}` : `0/0`;
}

function pickHeaderIndex(headerRow, candidates){
  const norm = (s) => String(s || '').trim().toLowerCase();
  const map = new Map(headerRow.map((h,i) => [norm(h), i]));
  for (const c of candidates){
    const idx = map.get(norm(c));
    if (idx != null) return idx;
  }
  return -1;
}

function initHeaderIndexes(){
  const headerRow = rows[0] || [];
  // Exact upload headers:
  headerIdx.loc = pickHeaderIndex(headerRow, ['Location']);
  headerIdx.upc = pickHeaderIndex(headerRow, ['upc', 'Expected UPC', 'UPC']);
  headerIdx.expCount = pickHeaderIndex(headerRow, ['Location On Hand']); // Column B expected count

  if (headerIdx.loc < 0) throw new Error('Missing header: Location');
  if (headerIdx.upc < 0) throw new Error('Missing header: upc');
  // expCount can be missing for queue rows; ok.
}

function loadCurrentExpected(){
  const row = rows[1 + currentIdx];
  if (!row) return;

  // ALWAYS read expected values from CURRENT row only
  state.expectedLocation = normalizeLocation(row[headerIdx.loc]);
  state.expectedUPC = normalizeUPC(row[headerIdx.upc]);
  state.expectedCount = (headerIdx.expCount >= 0) ? String(row[headerIdx.expCount] ?? '') : '';

  state.scannedUPC = '';
  state.scannedLocation = '';
  state.actualCount = null;
  state.rowScanStart = new Date();

  setStep('location');
  updateProgress();
}

async function postToSheet(payload){
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { raw:text }; }
}

async function fetchQueue(){
  const res = await fetch(API_URL + '?action=get_queue', { method:'GET' });
  const json = await res.json();
  if (json.result !== 'success') throw new Error(json.error || 'Queue fetch failed');
  return json.queue || [];
}

function buildRowsFromQueue(queue){
  rows = [['Location','upc','Location On Hand']];
  queue.forEach(q => rows.push([q.location, q.expected_upc, '']));
  initHeaderIndexes();
  currentIdx = 0;
  state.counts = { done:0, correct:0, incorrect:0, empty:0 };
  updateProgress();
  setStep('upload');
  ui.statusPill.textContent = 'Queue loaded';
  ui.subHint.textContent = 'Press Start to begin.';
  toast(`Queue: ${queue.length}`);
}

function upcStatus(){
  if (!state.scannedUPC) return 'Empty';
  return (state.scannedUPC === state.expectedUPC) ? 'Correct' : 'Incorrect';
}

async function finalizeAndPost(){
  const end = new Date();
  const start = state.rowScanStart || end;
  const durationSec = Math.max(0, Math.round((end - start) / 1000));
  const status = upcStatus();

  const payload = {
    timestamp: new Date().toISOString(),
    employee_name: state.employee,
    verification_mode: state.mode, // 'verification' or 'count'

    location: state.expectedLocation,
    expected_upc: state.expectedUPC,
    scanned_upc: state.scannedUPC,
    upc_status: status,

    expected_count: state.expectedCount, // blind
    actual_count: (state.mode === 'count') ? String(state.actualCount ?? '') : '',
    count_status: '',

    scan_start_time: start.toISOString(),
    scan_end_time: end.toISOString(),
    scan_duration_seconds: durationSec,

    step: currentIdx + 1,
    total_steps: totalSteps()
  };

  await postToSheet(payload);

  state.counts.done++;
  if (status === 'Correct') state.counts.correct++;
  else if (status === 'Incorrect') state.counts.incorrect++;
  else state.counts.empty++;

  updateProgress();

  beep(status === 'Correct');
  toast('Saved');

  currentIdx++;
  if (currentIdx >= totalSteps()){
    setStep('done');
    updateProgress();
    return;
  }
  loadCurrentExpected();
}

/** Scan handling **/
function handleScan(rawValue){
  if (!state.started) return;

  if (step === 'location'){
    const s = normalizeLocation(rawValue);
    state.scannedLocation = s;
    ui.lastScanVal.textContent = s || '—';

    if (s && s === state.expectedLocation){
      ui.statusPill.textContent = 'Location OK';
      ui.subHint.textContent = 'Now scan UPC.';
      beep(true);
      setTimeout(() => setStep('upc'), 80);
    } else {
      ui.statusPill.textContent = 'Wrong location';
      ui.subHint.textContent = 'Scan again.';
      beep(false);
    }
    return;
  }

  if (step === 'upc'){
    const s = normalizeUPC(rawValue);
    state.scannedUPC = s;
    ui.lastScanVal.textContent = s || '—';

    const status = upcStatus();
    ui.statusPill.textContent = status;

    if (state.mode === 'verification'){
      finalizeAndPost().catch(e => alert(e.message || String(e)));
      return;
    }

    openCountModal();
    setStep('count');
    return;
  }
}

/** Improved scan buffering **/
function resetBuffer() {
  scanBuffer = '';
  bufferStartTime = 0;
  bufferCharCount = 0;
  if (idleFinalizeTimer) clearTimeout(idleFinalizeTimer);
  idleFinalizeTimer = null;
}

function avgMsPerChar() {
  if (!bufferStartTime || bufferCharCount <= 1) return Infinity;
  const elapsed = performance.now() - bufferStartTime;
  return elapsed / bufferCharCount;
}

function armIdleFinalize() {
  if (idleFinalizeTimer) clearTimeout(idleFinalizeTimer);
  idleFinalizeTimer = setTimeout(() => {
    if (!scanBuffer) return;

    // Only auto-finalize if it arrived "scanner-fast"
    const avg = avgMsPerChar();
    const looksLikeScanner = avg <= SCAN_MAX_AVG_MS_PER_CHAR;
    if (!looksLikeScanner) return;

    const payload = scanBuffer;
    resetBuffer();
    handleScan(payload);
  }, SCAN_IDLE_FINALIZE_MS);
}

document.addEventListener('keydown', (e) => {
  // Don't capture keys while calculator modal is open
  if (ui.modalBackdrop.classList.contains('show')) return;

  if (!state.started) return;
  if (!['location','upc'].includes(step)) return;

  const now = performance.now();
  if (now - lastKeyTime > SCAN_TIMEOUT_MS) resetBuffer();
  lastKeyTime = now;

  // Many scanners use Enter OR Tab as suffix
  if (e.key === 'Enter' || e.key === 'Tab') {
    e.preventDefault();
    const payload = scanBuffer;
    resetBuffer();
    if (payload) handleScan(payload);
    return;
  }

  // Ignore non-character keys
  if (e.key.length !== 1) return;

  // Start timing on first char
  if (!bufferStartTime) bufferStartTime = performance.now();
  bufferCharCount++;

  scanBuffer += e.key;

  // Backup finalize if scanner doesn't send Enter/Tab
  armIdleFinalize();
});

/** Setup actions **/
ui.mode.addEventListener('change', () => {
  state.mode = ui.mode.value;
  setChipMode();

  const isCount = (ui.mode.value === 'count');
  ui.countSourceWrap.style.display = isCount ? 'block' : 'none';
  ui.loadQueueBtn.style.display = (isCount && ui.countSource.value === 'queue') ? 'inline-block' : 'none';

  setStep('upload');
});

ui.countSource.addEventListener('change', () => {
  ui.loadQueueBtn.style.display = (ui.mode.value === 'count' && ui.countSource.value === 'queue') ? 'inline-block' : 'none';
});

ui.loadQueueBtn.addEventListener('click', async () => {
  try{
    const q = await fetchQueue();
    if (!q.length){ toast('Queue empty'); return; }
    buildRowsFromQueue(q);
  } catch(e){
    alert(e.message || String(e));
  }
});

function readFile(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onerror = () => reject(r.error);
    r.onload = () => resolve(r.result);
    r.readAsArrayBuffer(file);
  });
}

ui.fileInput.addEventListener('change', async () => {
  const file = ui.fileInput.files?.[0];
  if (!file) return;

  // If count + queue selected, ignore uploads
  if (ui.mode.value === 'count' && ui.countSource.value === 'queue'){
    ui.fileInput.value = '';
    toast('Use Load Queue');
    return;
  }

  try{
    const buf = await readFile(file);
    const wb = XLSX.read(buf, { type:'array' });
    const name = wb.SheetNames[0];
    const ws = wb.Sheets[name];
    rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
    if (!rows.length) throw new Error('Sheet is empty.');
    initHeaderIndexes();
    if (rows.length < 2) throw new Error('No data rows found.');

    currentIdx = 0;
    state.counts = { done:0, correct:0, incorrect:0, empty:0 };
    updateProgress();
    setStep('upload');
    ui.statusPill.textContent = 'File loaded';
    ui.subHint.textContent = 'Press Start.';
    toast('File loaded');
  } catch(e){
    alert(e.message || String(e));
    resetAll();
  }
});

ui.startBtn.addEventListener('click', () => {
  const name = ui.employeeName.value.trim();
  if (!name){ toast('Enter name'); return; }
  if (!rows.length){
    if (ui.mode.value === 'count' && ui.countSource.value === 'queue') toast('Load Queue');
    else toast('Upload file');
    return;
  }

  state.employee = name;
  state.mode = ui.mode.value;
  state.started = true;

  currentIdx = 0;
  state.counts = { done:0, correct:0, incorrect:0, empty:0 };
  updateProgress();

  loadCurrentExpected();
  toast('Go!');
});

ui.submitBtn.addEventListener('click', () => {
  if (state.mode !== 'count' || step !== 'count') return;
  ui.submitBtn.disabled = true;
  finalizeAndPost().catch(e => { alert(e.message || String(e)); ui.submitBtn.disabled = false; });
});

ui.resetBtn.addEventListener('click', resetAll);

ui.stepCard.addEventListener('click', () => {
  toast('Ready for scans');
});

/** Calculator modal **/
let countEntry = '';

function openCountModal(){
  countEntry = '';
  ui.countDisplay.textContent = '0';
  ui.modalBackdrop.classList.add('show');
  ui.modalBackdrop.setAttribute('aria-hidden','false');
}

function closeCountModal(){
  ui.modalBackdrop.classList.remove('show');
  ui.modalBackdrop.setAttribute('aria-hidden','true');
}

function acceptCount(){
  const val = countEntry ? parseInt(countEntry, 10) : 0;
  state.actualCount = Number.isFinite(val) ? val : 0;
  ui.lastScanVal.textContent = String(state.actualCount);
  closeCountModal();
  ui.submitBtn.disabled = false;
  ui.statusPill.textContent = 'Count ready';
  ui.subHint.textContent = 'Press Submit to save.';
  toast('Count set');
}

ui.modalBackdrop.addEventListener('click', (e) => {
  if (e.target === ui.modalBackdrop){
    state.actualCount = 0;
    ui.lastScanVal.textContent = '0';
    closeCountModal();
    ui.submitBtn.disabled = false;
    toast('Count 0');
  }
});

document.querySelectorAll('.key').forEach(btn => {
  btn.addEventListener('click', () => {
    const k = btn.getAttribute('data-k');
    if (k === 'cancel'){
      state.actualCount = 0;
      ui.lastScanVal.textContent = '0';
      closeCountModal();
      ui.submitBtn.disabled = false;
      toast('Count 0');
      return;
    }
    if (k === 'clear'){
      countEntry = '';
      ui.countDisplay.textContent = '0';
      return;
    }
    if (k === 'del'){
      countEntry = countEntry.slice(0, -1);
      ui.countDisplay.textContent = countEntry || '0';
      return;
    }
    if (k === 'enter'){
      acceptCount();
      return;
    }
    countEntry += k;
    ui.countDisplay.textContent = countEntry;
  });
});

/** Reset **/
function resetAll(){
  rows = [];
  currentIdx = 0;
  headerIdx = { loc:-1, upc:-1, expCount:-1 };
  resetBuffer();
  lastKeyTime = 0;

  state.started = false;
  state.mode = ui.mode.value;
  state.employee = '';
  state.expectedLocation = '';
  state.expectedUPC = '';
  state.expectedCount = '';
  state.scannedUPC = '';
  state.scannedLocation = '';
  state.actualCount = null;
  state.rowScanStart = null;
  state.counts = { done:0, correct:0, incorrect:0, empty:0 };

  ui.fileInput.value = '';
  updateProgress();
  setStep('upload');
  setChipMode();
  setChipStep('UPLOAD');
}

/** Init **/
resetAll();
</script>
</body>
</html>
